<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>fable-collector — tableau de bord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#0b1020;--fg:#e8eef6;--muted:#9fb3c8;--accent:#4cc9f0;
      --ok:#2dd4bf;--warn:#f59e0b;--bad:#ef4444;--card:#0f172a;--br:#23304a
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:24px;background:var(--bg);color:var(--fg)}
    a{color:var(--accent)}
    header{display:flex;flex-wrap:wrap;gap:8px;align-items:baseline;margin-bottom:16px}
    header h1{font-size:1.4rem;margin:0}
    .pill{border:1px solid var(--br);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:.85rem}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{border:1px solid var(--br);background:var(--card);padding:14px;border-radius:14px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--br);font-size:.92rem}
    th{text-align:left;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono","Courier New",monospace}
    .small{font-size:.9rem;color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    footer{margin-top:24px;color:var(--muted);font-size:.9rem}
    .badge{display:inline-block;background:#152033;border:1px solid var(--br);border-radius:8px;padding:2px 8px;margin-left:6px}
    .status{display:inline-block;border-radius:8px;padding:2px 8px;margin-left:8px;color:#0b1020;font-weight:600}
    .status.ok{background:var(--ok)} .status.warn{background:var(--warn)} .status.bad{background:var(--bad)}
    ul{margin:8px 0 0 18px}
  </style>
</head>
<body>
<header>
  <h1>fable-collector — tableau de bord</h1>
  <span id="tz" class="pill"></span>
  <span id="gen" class="pill"></span>
  <span id="hc" class="status warn">Statut: …</span>
</header>

<div class="cards">
  <div class="card">
    <h3>Liens rapides</h3>
    <ul id="quicklinks">
      <!-- rempli par JS selon fichiers présents -->
    </ul>
    <p class="small">Inventaire basé sur <span class="mono">index.json</span>.</p>
  </div>
  <div class="card">
    <h3>Résumé fenêtres</h3>
    <div id="wins">Chargement…</div>
  </div>
</div>

<h3 style="margin-top:18px">Spots collectés</h3>
<div class="card">
  <table id="files"><thead>
    <tr><th>Fichier</th><th>Taille</th><th>Modifié</th><th>Type</th></tr>
  </thead><tbody></tbody></table>
</div>

<footer>
  <p>Affichage en <span id="tz2" class="mono"></span>. Les heures dans les fichiers sont ISO (avec ou sans offset) et s’entendent côté collecte (souvent Africa/Tunis).</p>
</footer>

<script>
(async function(){
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>document.querySelectorAll(sel);

  $('#tz').textContent = 'Affichage: ' + tz;
  $('#tz2').textContent = tz;

  const wantSpots = [
    ['Gammarth (home)', 'gammarth-port.json'],
    ['Sidi Bou Saïd',   'sidi-bou-said.json'],
    ['Ghar el Melh',    'ghar-el-melh.json'],
    ['Ras Fartass',     'ras-fartass.json'],
    ['El Haouaria',     'el-haouaria.json']
  ];

  const fmtBytes = (n)=>{
    if(n==null) return '';
    if(n<1024) return n+' B';
    if(n<1024*1024) return (n/1024).toFixed(1)+' kB';
    return (n/1024/1024).toFixed(1)+' MB';
  };
  const toLocal = (iso)=>{
    try{ const d=new Date(iso); return isNaN(d)? iso : d.toLocaleString(); }
    catch(e){ return iso||''; }
  };
  const fetchJSON = async (path)=>{
    try{
      const r = await fetch(path, {cache:'no-store'});
      if(!r.ok) throw new Error(r.status+' '+r.statusText);
      return await r.json();
    }catch(e){ return null; }
  };

  const index = await fetchJSON('index.json');
  const status = await fetchJSON('status.json'); // peut être null
  const windows = await fetchJSON('windows.json'); // peut être null
  // nouveau : on essaie catalog.json si index.json n'a pas .files
  const catalog = await fetchJSON('catalog.json'); // peut être null

  const files = (index && Array.isArray(index.files)) ? index.files
              : (catalog && Array.isArray(catalog.files)) ? catalog.files
              : [];

  // pastille statut (status.json)
  const hc = $('#hc');
  if(status && Array.isArray(status.files)){
    const ok = !!status.all_fresh;
    hc.className = 'status ' + (ok ? 'ok' : 'warn');
    hc.textContent = (ok ? 'Statut: OK (fichiers frais)' : 'Statut: ATTENTION (anciens)');
  }else{
    hc.className = 'status bad';
    hc.textContent = 'Statut: indisponible';
  }

  // généré à…
  const gen = (windows && windows.generated_at)
           || (index && index.generated_at)
           || (catalog && catalog.generated_at)
           || null;
  $('#gen').textContent = 'Généré: ' + (gen ? toLocal(gen) : 'inconnu');

  // liens rapides selon fichiers présents
  const present = new Set(files.map(f => typeof f==='string' ? f : f.path));
  const links = [
    ['index.json','index.json'],
    present.has('status.json') ? ['status.json','status.json'] : null,
    present.has('status.html') ? ['status.html','status.html'] : null,
    present.has('rules.normalized.json') ? ['rules.normalized.json','rules.normalized.json'] : null,
    present.has('windows.json') ? ['windows.json','windows.json'] : null
  ].filter(Boolean);
  const ql = $('#quicklinks');
  ql.innerHTML = links.map(([label,href])=>`<li><a href="${href}">${label}</a></li>`).join('');

  // table des fichiers (depuis index.json)
  const tbody = $('#files tbody');
  if(files.length===0){
    tbody.innerHTML = '<tr><td colspan="4" class="small warn">Aucun fichier listé.</td></tr>';
  }else{
    for(const f of index.files){
      const p = typeof f==='string' ? f : (f.path || '');
      const size = (typeof f==='string' ? '' : humanSize(f.size));
      const mod  = (typeof f==='string' ? '' : toLocal(f.modified));
      let kind = 'spot';
      if(p === 'index.json') kind = 'index';
      else if(p === 'status.json' || p === 'status.html') kind = 'status';
      else if(p === 'rules.normalized.json') kind = 'rules';
      else if(p === 'windows.json') kind = 'windows';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="${encodeURIComponent(p)}">${p}</a></td>
        <td class="mono">${size||''}</td>
        <td class="mono">${mod||''}</td>
        <td>${kind}</td>`;
      tbody.appendChild(tr);
    }
  }

  // résumé des fenêtres (windows.json)
  const winsDiv = $('#wins');
  if(!windows || !Array.isArray(windows.windows)){
    winsDiv.innerHTML = '<span class="small">windows.json introuvable ou vide.</span>';
  }else if(windows.windows.length === 0){
    winsDiv.innerHTML = '<span class="small">Aucune fenêtre détectée.</span>';
  }else{
    const ul = document.createElement('ul');
    for(const dest of windows.windows){
      const name = dest.dest_name || dest.dest_slug || '?';
      const li = document.createElement('li');
      const spans = [];
      if(Array.isArray(dest.windows) && dest.windows.length){
        for(const seg of dest.windows){
          const start = seg.start ? toLocal(seg.start) : '?';
          const end   = seg.end ? toLocal(seg.end) : '?';
          const conf  = seg.confidence || '';
          spans.push(`${start} → ${end} <span class="badge">${seg.hours} h</span> <span class="badge">${conf}</span>`);
        }
        li.innerHTML = `<span class="ok">${name}</span><br><span class="small">${spans.join('<br>')}</span>`;
      }else{
        li.innerHTML = `<span>${name}</span> <span class="small">— aucune fenêtre</span>`;
      }
      ul.appendChild(li);
    }
    winsDiv.innerHTML = '';
    winsDiv.appendChild(ul);
  }
<details class="card" style="margin-top:16px">
  <summary style="cursor:pointer">Format JSON (extrait)</summary>
  <pre class="small" style="white-space:pre-wrap">
{
  "meta": {
    "name": "Gammarth (port)",
    "slug": "gammarth-port.json",
    "tz": "Africa/Tunis",
    "lat": 36.9203,
    "lon": 10.2846,
    "sources": ["open-meteo:ecmwf", "open-meteo:marine"]
  },
  "hourly": {
    "time": ["2025-09-12T00:00", "2025-09-12T01:00", "..."],
    "wind_speed_10m": [..km/h..],
    "wind_gusts_10m": [..km/h..],
    "wind_direction_10m": [..deg..],
    "weather_code": [..wmo..],
    "visibility": [..m ou km..],
    "hs": [..m..],       // alias: wave_height
    "tp": [..s..]        // alias: wave_period
  }
}
  </pre>
</details>

  
})();
</script>
</body>
</html>
