<!doctype html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>TABLEAU DE BORD FABLE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
 
  <style>
 
    :root{
      --bg:#0b1020; --fg:#e8eef6; --muted:#a6b7c9; --accent:#4cc9f0;
      --ok:#2dd4bf; --warn:#f59e0b; --bad:#ef4444; --card:#0f172a; --br:#23304a;
      --section:#9ad9ff; --shadow: 0 1px 0 rgba(255,255,255,.03) inset, 0 6px 20px rgba(0,0,0,.35);
      --link:#7dd3fc; --pill-bg:#0d1a2b;
    }
    [data-theme="nautical"]{
      --bg:#ebedf0; --fg:#0b1424; --muted:#475569; --accent:#0ea5e9;
      --ok:#2dd4bf; --warn:#b45309; --bad:#b91c1c; --card:#ffffff; --br:#d9e1ea;
      --section:#0ea5e9; --shadow: 0 1px 0 rgba(0,0,0,.03) inset, 0 6px 18px rgba(2,6,23,.08);
      --link:#0284c7; --pill-bg:#f1f5f9;
    }
    [data-theme="light"] {
      --bg: #fdfdfd; --fg: #0a2240; --muted: #5b6a7e; --accent: #0077b6;
      --ok: #1a936f; --warn: #f78c2a; --bad: #c83e4d; --card: #ffffff; --br: #e1e8f0;
      --section:#005b96; --shadow: 0 4px 12px rgba(10,34,64,.08);
      --link:#0077b6; --pill-bg:#f0f5fa;
    }
    
    /* éviter le scroll induit par margin+height:100% */
    html,body{min-height:100%}
    /* TV mode: no page scroll, only cards can scroll */
    html, body { overflow: hidden; }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      margin:0;                /* <- plus de margin */
      padding:24px;            /* <- padding à la place */
      background:var(--bg);
      color:var(--fg);
      font-size: 1.05rem;
      min-height:100vh;        /* tient sur la hauteur du viewport */
    }
    @supports (height: 100dvh) {
      body{ min-height:100dvh; }  /* viewport dynamique si dispo */
    }
    
    /* plein écran via Fullscreen API : html est l’élément en fullscreen */
    html:fullscreen body{
      padding:16px;       /* un peu moins de padding en FS */
      overflow:auto;    /* laisse scroller si le contenu dépasse */
    }
    
    #dashboard-content{transition:opacity .5s ease-in-out}
    #dashboard-content.updating{opacity:.3}

    .layout-grid{ display:grid; gap:16px; }
    .card{border:1px solid var(--br);background:var(--card);padding:16px;border-radius:14px; box-shadow: var(--shadow)}
    .card h3{font-size:1.15rem; color:var(--section); display:flex; align-items:center; gap:8px; justify-content: space-between;}
   
    .window-line{padding:10px 12px;border:1px solid var(--br);border-radius:12px;margin-bottom:8px}
    .window-line .title{font-weight:700; font-size: 1.1rem; display:flex; align-items:center}
    .window-line .tripline { margin-top:6px; opacity:.9 }

    .go{display:inline-block;border-radius:10px;padding:2px 8px;margin-left:8px;font-weight:800}
    .go.family{background:var(--ok); color:#04110a}
    .go.expert{background:#f59e0b; color:#160f04}
    .conf{border:1px solid var(--br);background:var(--pill-bg);border-radius:999px;padding:2px 8px;margin-left:8px;font-weight:700;font-size:.82rem;color:var(--muted);white-space:nowrap}
    .conf.high{color:var(--ok)} .conf.medium{color:var(--warn)} .conf.low{color:var(--bad)}
    .conditions .line{border-left:4px solid var(--warn); padding:10px 12px; border-radius:8px; margin-bottom:8px}
    .conditions .line.ok{   border-left-color: var(--ok); }
    .conditions .line.warn{ border-left-color: var(--warn); }
    .conditions .line.bad{  border-left-color: var(--bad); }

    .table-wrap{overflow:auto;border:1px solid var(--br);border-radius:14px}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 12px; border-bottom:1px solid var(--br); font-size:.95rem}
    /* Fix: les liens visités restaient mauves (couleur navigateur) */
    a:visited, a:active { color: var(--link); }
    
    /* Couleurs du statut dans le tableau (Fresh/Stale) */
    .status-val{ font-weight:600; }
    .status-val.ok   { color: var(--ok); }
    .status-val.warn { color: var(--warn); }
    .status-val.bad  { color: var(--bad); }
    .table-wrap .status-val.ok   { color: var(--ok) !important; }
    .table-wrap .status-val.warn { color: var(--warn) !important; }
    .table-wrap .status-val.bad  { color: var(--bad) !important; }

    th{text-align:left;color:var(--muted); position:sticky; top:0; background:var(--card)}

    .tip{position:absolute; z-index:9999; max-width:360px; padding:8px 10px; border-radius:10px; background:var(--card); border:1px solid var(--br); box-shadow:var(--shadow); font-size:.9rem}
    .tip .hdr{font-weight:700; margin-bottom:4px} .tip .row{margin-top:4px}

    body.simplified-view .expert-only{display:none}
    /* En vue simplifiée, on cache le Radar (et donc Données Brutes) */
    body.simplified-view .card.radar{ display:none; }

    footer{margin-top:24px;color:var(--muted);font-size:.9rem}
    #refresh-timer{font-size:.85rem;color:var(--muted);margin-left:16px}

    .marker-pin{width:30px; height:30px; border-radius:50% 50% 50% 0; position:absolute; transform:rotate(-45deg); left:50%; top:50%; margin:-15px 0 0 -15px}
    .marker-pin::after{content:''; width:14px; height:14px; margin:8px 0 0 8px; background:#fff; position:absolute; border-radius:50%}
    .marker-pulse:after{content:""; border-radius:50%; height:40px; width:40px; position:absolute; margin:-13px 0 0 -13px; animation:pulsate 1.5s ease-out infinite; opacity:0; box-shadow:0 0 1px 2px var(--accent); border:3px solid rgba(255,255,255,0.3)}
    @keyframes pulsate{0%{transform:scale(.1);opacity:0}50%{opacity:1}100%{transform:scale(1.2);opacity:0}}
    .main-port-icon .marker-pulse:after{animation-name:pulsate-main; animation-duration:1.2s; box-shadow:0 0 2px 3px var(--accent); border:3px solid rgba(76,201,240,0.5)}
    @keyframes pulsate-main{0%{transform:scale(.1);opacity:0}50%{opacity:1}100%{transform:scale(1.5);opacity:0}}

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono","Courier New",monospace}
    .small{font-size:.92rem;color:var(--muted)}

    /* Sparklines */
    .spark{width:120px;height:24px;display:inline-block;vertical-align:middle;margin-left:8px}
    .spark svg{width:100%;height:100%}

    /* Corridors / ancrage */
    .anchor-badge{
      background: var(--card);
      border: 1px solid var(--br);
      color: var(--fg);
      padding: 2px 6px;
      border-radius: 999px;
      font-size: .85rem;
      font-weight: 700;
      box-shadow: var(--shadow);
      pointer-events: none;
    }

    /* bigger, multi-line corridor badge */
    .anchor-badge.trip {
      padding: 8px 10px;
      font-size: .9rem;
      line-height: 1.25;
      white-space: normal;       /* allow wrap */
      max-width: 260px;          /* keep it compact */
    }
    .anchor-badge.trip .h { font-weight: 800; margin-bottom: 2px; }
    .anchor-badge.trip .m { opacity: .9; }
  
    /* Boat marker for the animation */
    .boat-icon{
      font-size: 22px;                 /* readable on TV/desktop */
      line-height: 1;
      transform: translate(-50%, -50%);
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.35));
    }
    @media (max-width: 600px){
      .boat-icon{ font-size: 18px; }   /* phone */
    }
    
    .leaflet-div-icon{
      background: transparent !important;
      border: none !important;
      box-shadow: none !important;
    }
    
    /* fenêtre sélectionnée */
    .window-line.select { outline:2px solid var(--accent); box-shadow:0 0 0 4px rgba(76,201,240,.15) }
    /* curseur cliquable */
    .window-line { cursor:pointer }
    /* tooltip joli pour la ligne */
    .leaflet-tooltip{
      background: var(--card);
      color: var(--fg);
      border: 1px solid var(--br);
      box-shadow: var(--shadow);
      padding: 6px 8px;
      border-radius: 8px;
    }

    /* Toggle pill (thème & langue) */
    .toggle{display:inline-flex;border:1px solid var(--br);border-radius:999px;overflow:hidden;background:var(--pill-bg)}
    .toggle button{padding:4px 10px;font-weight:700;border:0;background:transparent;color:var(--muted);cursor:pointer}
    .toggle button.active{background:var(--accent); color:#041019}
    .toggle button:not(.active):hover{background:rgba(255,255,255,.06)}
    
    /* Alerte douce */
    @keyframes flashPulse{0%{box-shadow:0 0 0 0 rgba(76,201,240,.6)}100%{box-shadow:0 0 0 18px rgba(76,201,240,0)}}
    .card.flash{animation:flashPulse .8s ease-out 1}
    
    /* OK pulse + chip (theme-aware via --ok) */
    @keyframes okPulse{
      0%   { box-shadow: 0 0 0 0  rgb(from var(--ok) r g b / .55); }
      70%  { box-shadow: 0 0 0 12px rgb(from var(--ok) r g b / 0); }
      100% { box-shadow: 0 0 0 0  rgb(from var(--ok) r g b / 0); }
    }
    .status{
      display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;line-height:1
    }
    .status.ok{
      /* soft fill from --ok + readable text for both themes */
      background: rgb(from var(--ok) r g b / .18);
      color: var(--fg);
      border: 1px solid rgb(from var(--ok) r g b / .7);
    }
    .status.warn{
      background: rgba(245,158,11,.15);
      color: var(--warn);
      border: 1px solid rgba(245,158,11,.35);
    }
    .status.ok.pulse{ animation: okPulse .9s ease-out 1; }


    /* AR lisible */
    :root[dir="rtl"] body{font-family:"Noto Naskh Arabic","Amiri",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    :root[dir="rtl"] h1, :root[dir="rtl"] h3 { letter-spacing:.2px }
    :root{ --map-h: 450px; }

    #map{
      height: var(--map-h);
      min-height: 260px;        /* garde-fou */
      border-radius: 14px;
      background: var(--card);
      border: 1px solid var(--br);
      margin-bottom: 16px;
      z-index: 0;
    }

    /* Grille 3 colonnes sur desktop */
    .layout-grid.threecol{
      display:grid;
      grid-template-columns: 1.4fr 1.1fr 1.1fr; /* Fenêtres | Avertissements | Radar */
      gap:16px;
    }
    
    /* Cartes bornées en hauteur pour éviter le scroll de page */
    .card.wins{       max-height: 49vh; overflow:auto; }
    .card.conditions{ max-height: 49vh; overflow:auto; }
    .card.radar{      max-height: 49vh; overflow:auto; }
    
    /* Empilement sur mobile/tablette */
    @media (max-width: 1100px){
      .layout-grid.threecol{ grid-template-columns:1fr; }
      .card.wins, .card.conditions, .card.radar{ max-height:none; }
    }

    /* Header layout & buttons */
  .app-header{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:12px}
  .app-header h1{margin:0;font-size:1.5rem;white-space:nowrap}
  .hdr-tools{display:flex;align-items:center;gap:10px;margin-left:auto}
  .btn{border:1px solid var(--br);background:var(--pill-bg);padding:6px 10px;border-radius:999px;color:var(--fg);cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn-mini{border:1px solid var(--br);background:transparent;padding:2px 6px;border-radius:8px;color:var(--muted);cursor:pointer}

  /* Slim scrollbars for scrollable cards */
  .card.wins, .card.conditions, .card.radar{
    scrollbar-width: thin;                /* Firefox */
    scrollbar-color: var(--br) transparent;
  }
  .card.wins::-webkit-scrollbar,
  .card.conditions::-webkit-scrollbar,
  .card.radar::-webkit-scrollbar{        /* WebKit */
    width: 8px;
    height: 8px;
  }
  .card.wins::-webkit-scrollbar-track,
  .card.conditions::-webkit-scrollbar-track,
  .card.radar::-webkit-scrollbar-track{
    background: transparent;
  }

  /* Trip summary pill inside a selected window */
  .tripline{
    margin-top:8px;
    padding:8px 10px;
    border:1px dashed var(--br);
    border-radius:10px;
    background: rgb(from var(--pill-bg) r g b / .65);
  }
  .tripline .row{display:flex;gap:8px;align-items:center;margin-top:4px}
  .tripline .k{font-weight:800}
  .tripline .v{opacity:.95}

  .card.wins::-webkit-scrollbar-thumb,
  .card.conditions::-webkit-scrollbar-thumb,
  .card.radar::-webkit-scrollbar-thumb{
    background: var(--br);
    border-radius: 999px;
    border: 2px solid transparent;
    background-clip: padding-box;
  }
</style>
</head>
<body>
<header class="app-header">
    <h1>🧭 FABLE: Tableau de Bord</h1>
  
    <div class="hdr-tools">
      <span id="gen" class="pill" aria-live="polite"></span>
  
      <button id="viewToggleBtn" class="btn">Vue Simplifiée</button>
  
      <div id="themeToggle" class="toggle" title="Thème">
        <button data-theme="dark" aria-pressed="false">🌙</button>
        <button data-theme="nautical" aria-pressed="false">⚓</button>
      </div>
  
      <button id="muteBtn" class="btn" title="Alerte sonore">🔔</button>
  
      <div id="langToggle" class="toggle" title="Langue">
        <button data-lang="fr" aria-pressed="false">FR</button>
        <button data-lang="en" aria-pressed="false">EN</button>
      </div>
  
      <span id="hc" class="status warn" role="status">Statut: …</span>
      <button id="fullscreenBtn" class="btn" title="Plein écran">⛶</button>
    </div>
  </header>
<div id="dashboard-content">
  <div id="map" aria-label="Carte des spots"></div>

  <div class="layout-grid threecol">
    <!-- 1) Fenêtres -->
    <div class="card wins">
      <h3>
        <span>🪟 Fenêtres de Navigation</span>
        <button id="resetMapBtnTop" class="btn" title="Vue initiale">🧭</button>
      </h3>
      <div id="wins">Chargement…</div>
    </div>
  
    <!-- 2) Avertissements (No-GO) -->
    <div class="card conditions">
      <h3><span>🚦 Avertissements (No-GO)</span></h3>
      <div id="reasons">Chargement…</div>
    </div>
  
    <!-- 3) Radar des Spots -->
    <div class="card radar">
      <h3>
        <span>📡 Radar des Spots</span>
        <button id="resetMapBtn" class="btn" title="Vue initiale">🔄</button>
      </h3>
      <div class="table-wrap">
        <table id="files">
          <thead><tr><th>Spot</th><th>Statut</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <details class="sub" style="margin-top:16px;">
        <summary>📚 Données Brutes</summary>
        <ul id="raw-links-list"></ul>
      </details>
  </div>
</div>
</div> <!-- 🔧 ferme #dashboard-content -->

<footer>
  <p><span id="tz" class="small"></span><span id="refresh-timer"></span></p>
</footer>

<div id="tooltip" class="tip" style="display:none;" role="tooltip"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="./reasons-debug.js"></script>

<script>
(async function main() {
  const REFRESH_INTERVAL_SECONDS = 600;

  // ===== I18N =====
  const I18N = {
    fr:{status_ok:"Statut: OK",status_stale:"Statut: Données anciennes",updated:"Mise à jour",reasons_unavailable:"Raisons indisponibles.",none_windows:'Aucune fenêtre "GO" détectée.',fresh:"Frais",stale:"Ancien",next_refresh:s=>`Prochaine MAJ dans ${s}s.`,principal_port:"Port Principal",go_popup:{green:"Fenêtre 'GO' !",yellow:"Données à jour",red:"Données anciennes"},conf_title:(t,s)=>`Confiance: ${t}${s!=null?' · '+s+'%':''}`},
    en:{status_ok:"Status: OK",status_stale:"Status: Stale data",updated:"Updated",reasons_unavailable:"Reasons unavailable.",none_windows:'No "GO" window detected.',fresh:"Fresh",stale:"Stale",next_refresh:s=>`Next refresh in ${s}s.`,principal_port:"Main Port",go_popup:{green:"GO window!",yellow:"Data up to date",red:"Stale data"},conf_title:(t,s)=>`Confidence: ${t}${s!=null?' · '+s+'%':''}`},
  };
  const LOCALES = { fr:'fr-FR', en:'en-GB' };

  // Spots & config
  const spotConfig = {
    'gammarth-port.json':{name:'Gammarth Port',lat:36.921,lon:10.310},
    'sidi-bou-said.json':{name:'Sidi Bou Saïd',lat:36.865,lon:10.351},
    'ghar-el-melh.json':{name:'Ghar el Melh',lat:37.177,lon:10.280},
    'ras-fartass.json':{name:'Ras Fartass',lat:36.877,lon:10.613},
    'el-haouaria.json':{name:'El Haouaria',lat:37.063,lon:11.008}
  };
  const WANT_SPOTS = Object.entries(spotConfig).map(([file,{name}]) => [name,file]);
  const INITIAL_MAP_VIEW = { center:[36.95,10.6], zoom:9 };
  // Where to pin the transit badge instead of the midpoint
  const TRANSIT_BADGE_ANCHOR = {
    'gammarth-port.json': [36.916486, 10.312356]
  };

  // --- Corridor helpers (cache + séries + vent au plus proche) ---
  const SPOT_CACHE = new Map();
  async function loadSpotJSON(file){
    if(SPOT_CACHE.has(file)) return SPOT_CACHE.get(file);
    const js = await fetchJSON(file);
    SPOT_CACHE.set(file, js||{});
    return js||{};
  }
  function seriesFromSpot(js){
    const h = js?.hourly || {};
    const alt = Array.isArray(js?.hours) ? js.hours : null;
    return {
      time:      h.time || (alt ? alt.map(r=>r.time) : []),
      wind:      h.wind_speed_10m || (alt ? alt.map(r=>r.wind_kmh) : []),
      gusts:     h.wind_gusts_10m || (alt ? alt.map(r=>r.gust_kmh) : []),
      wind_dir:  h.wind_direction_10m || (alt ? alt.map(r=>r.wind_dir_deg ?? r.wind_dir) : []),
    };
  }
  function nearestIdx(times, iso){
    const t = new Date(iso).getTime(); let best=1e15, idx=-1;
    times.forEach((s,i)=>{ const d=Math.abs(new Date(s).getTime()-t); if(d<best){best=d; idx=i;} });
    return idx;
  }
  async function windAt(file, iso){
    const js = await loadSpotJSON(file);
    const s = seriesFromSpot(js);
    if(!s.time?.length) return {dir:null, spd:null, gst:null};
    const i = nearestIdx(s.time, iso);
    return { dir: s.wind_dir?.[i] ?? null, spd: s.wind?.[i] ?? null, gst: s.gusts?.[i] ?? null };
  }
  function degToCardinal(d){
    if(d==null||!isFinite(d)) return '—';
    const dirs=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
    return dirs[Math.round(((d%360)+360)%360/22.5)%16];
  }
  // petite haversine
  const R_EARTH = 6371, KM_PER_NM = 1.852;
  const toRad = d=>d*Math.PI/180;
  function distKm(a,b){
    const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
    const la1=toRad(a.lat), la2=toRad(b.lat);
    const x=Math.sin(dLat/2)**2 + Math.cos(la1)*Math.cos(la2)*Math.sin(dLon/2)**2;
    return 2*R_EARTH*Math.asin(Math.sqrt(x));
  }
  // petite anim le long d'une ligne (interpolation linéaire)
  let _animTimer=null;
  // ⛵ animate from A→B or B→A; returns a Promise (finishes ~1.3s = 30% slower)
  function animateBoat(line, { direction = 1, duration = 1300 } = {}){
      return new Promise(resolve=>{
        const [A,B] = line.getLatLngs();
        const start = (direction===1)? A : B;
        const end   = (direction===1)? B : A;
    
        const icon = L.divIcon({ className:'boat-icon', html:'⛵' });
        const boat = L.marker(start, { icon, interactive:false }).addTo(corridorLayer);
    
        const t0 = performance.now();
        const step = (now)=>{
          const u = Math.min(1, (now - t0) / duration);          // 0→1
          const lat = start.lat + (end.lat - start.lat) * u;
          const lng = start.lng + (end.lng - start.lng) * u;
          boat.setLatLng([lat, lng]);
    
          if(u < 1) requestAnimationFrame(step);
          else { corridorLayer.removeLayer(boat); resolve(); }
        };
        requestAnimationFrame(step);
      });
    }


  // ===== State & helpers =====
  let LANG = localStorage.getItem('lang') || 'fr';
  let muted = localStorage.getItem('mute') === '1';
  let lastWinsKey = new Set();

  const $ = sel => document.querySelector(sel);
  const t = (path,...args)=>{const d=I18N[LANG]||I18N.fr; const v=path.split('.').reduce((o,k)=>(o||{})[k],d); return typeof v==='function'?v(...args):(v??path);};
  const fmtLocal = iso => iso ? new Date(iso).toLocaleString(LOCALES[LANG]||'fr-FR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : '';
  const fmtFriendly = iso => iso ? new Date(iso).toLocaleString(LOCALES[LANG]||'fr-FR',{weekday:'long',hour:'numeric',minute:'2-digit',hour12:false}) : '';
  const fetchJSON = async (path) => { try{ const r=await fetch(path,{cache:'no-store'}); return r.ok? r.json(): null; }catch{ return null; }};

  const isFamilyWindow = (startIso,endIso) => { const s=new Date(startIso), e=new Date(endIso); if(isNaN(s)||isNaN(e)) return true; for(let d=new Date(s); d<=e; d.setHours(d.getHours()+1)){const h=d.getHours(); if(h<8||h>=21) return false;} return true; };
  const isFresh = (entry,genIso) => { const T=180; if(!entry) return false; if(typeof entry.fresh==='boolean') return entry.fresh; if(entry.modified){const age=(Date.now()-new Date(entry.modified))/60000; if(isFinite(age)) return age<=T;} if(genIso){const age=(Date.now()-new Date(genIso))/60000; if(isFinite(age)) return age<=T;} return false; };

  const ding = ()=>{ if(muted) return; try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(), o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.0001,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.05,ctx.currentTime+0.02); g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+0.22); o.start(); o.stop(ctx.currentTime+0.25);}catch{} };
  const flash = el => { el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash'); };

  const sparklineSVG = (seriesList, opts={})=>{
    const W=120,H=24,p=2;
    const flat = seriesList.flat().map(Number).filter(Number.isFinite);
    const min = (opts.min ?? Math.min(...flat, 0));
    const max = (opts.max ?? Math.max(...flat, 1));
    const span = (max - min) || 1;
    const path = v=>{
      const values=v.map(Number).filter(Number.isFinite);
      if(!values.length) return '';
      const n=values.length;
      return values.map((val,i)=>{
        const x=p+(W-2*p)*(n===1?1:i/(n-1));
        const y=p+(H-2*p)*(1-(val-min)/span);
        return `${i?'L':'M'}${x.toFixed(1)} ${y.toFixed(1)}`;
      }).join(' ');
    };
    const colors = opts.colors || ['currentColor','rgba(255,255,255,.6)'];
    return `<svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
      ${seriesList.map((s,i)=>`<path d="${path(s)}" fill="none" stroke="${colors[i%colors.length]}" stroke-width="${i===0?1.8:1.2}" stroke-linecap="round"/>`).join('')}
    </svg>`;
  };

  // Map
  const map = L.map('map').setView(INITIAL_MAP_VIEW.center, INITIAL_MAP_VIEW.zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
  const corridorLayer = L.layerGroup().addTo(map);
  const spotsLayer    = L.layerGroup().addTo(map);
  window.panToFile = (file)=>{ const s=spotConfig[file]; if(s) map.setView([s.lat,s.lon],12,{animate:true}); };

  // ===== KIOSK =====
  setTimeout(()=>{ if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); }, 5000);
  let cursorTimer; const hideCursor=()=>document.body.style.cursor='none';
  const showCursor=()=>{document.body.style.cursor='';clearTimeout(cursorTimer);cursorTimer=setTimeout(hideCursor,5000);};
  ['mousemove','keydown','click','wheel','touchstart'].forEach(ev=>document.addEventListener(ev,showCursor,{passive:true}));
  showCursor();
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ updateDashboard(); if(!document.fullscreenElement) document.documentElement.requestFullscreen().catch(()=>{}); } });

  // ===== UI setup =====
  $('#tz').textContent = `Affichage en ${Intl.DateTimeFormat().resolvedOptions().timeZone}.`;

  // Langue (FR/EN uniquement)
  const langToggle = $('#langToggle');
  const languages = ['fr','en'];
  if(!languages.includes(LANG)) LANG='fr';
  function setLangUI(l){
    LANG=l; localStorage.setItem('lang', l);
    document.documentElement.lang = l;
    document.documentElement.dir  = 'ltr';
    langToggle.querySelectorAll('button').forEach(b=>{
      const on = b.dataset.lang===l;
      b.classList.toggle('active', on);
      b.setAttribute('aria-pressed', on?'true':'false');
    });
  }
  langToggle.addEventListener('click', e=>{
    const btn=e.target.closest('button[data-lang]'); if(!btn) return;
    setLangUI(btn.dataset.lang);
    updateDashboard();
  });
  setLangUI(LANG);

  // Son
  const btnMute = $('#muteBtn');
  const setMuteUI = m => { muted=m; localStorage.setItem('mute', m?'1':'0'); btnMute.textContent = m?'🔕':'🔔'; };
  setMuteUI(muted);
  btnMute.addEventListener('click', ()=> setMuteUI(!muted));

  // Thème (Dark/Nautical uniquement)
  const themes=['dark','nautical'];
  let theme = localStorage.getItem('theme') || document.documentElement.getAttribute('data-theme') || 'dark';
  if(!themes.includes(theme)) theme='dark';
  const themeToggle = $('#themeToggle');
  function applyTheme(t){
    document.documentElement.setAttribute('data-theme', t);
    localStorage.setItem('theme', t);
    themeToggle.querySelectorAll('button').forEach(b=>{
      const isActive = b.dataset.theme===t;
      b.classList.toggle('active', isActive);
      b.setAttribute('aria-pressed', isActive?'true':'false');
    });
  }
  themeToggle.addEventListener('click', e=>{
    const btn=e.target.closest('button[data-theme]'); if(!btn) return;
    applyTheme(btn.dataset.theme);
  });
  applyTheme(theme);

  // Plein écran
  $('#fullscreenBtn').addEventListener('click', ()=> document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen());

  // Vue simplifiée
  $('#viewToggleBtn').addEventListener('click', ()=>{
    const s=document.body.classList.toggle('simplified-view');
    $('#viewToggleBtn').textContent = s ? 'Vue Experte' : 'Vue Simplifiée';
    updateDashboard();
  });

  // Reset map
  document.getElementById('resetMapBtnTop')?.addEventListener('click', () =>
    map.setView(INITIAL_MAP_VIEW.center, INITIAL_MAP_VIEW.zoom, {animate:true})
  );
  
  // Reset map (bouton 🔄 dans "Radar des Spots")
  document.getElementById('resetMapBtn')?.addEventListener('click', () =>
    map.setView(INITIAL_MAP_VIEW.center, INITIAL_MAP_VIEW.zoom, { animate: true })
  );
  // Tooltip
  const tipEl = $('#tooltip');
  const hideTip = ()=>{ tipEl.style.display='none'; };
  document.addEventListener('scroll', hideTip, {passive:true});

  ['.card.wins','.card.conditions','.card.radar'].forEach(sel=>{
    document.querySelector(sel)?.addEventListener('scroll', hideTip, {passive:true});
  });
  
  // ===== Rendu principal =====
  async function updateDashboard(){
    $('#dashboard-content').classList.add('updating');

    const [status, windows] = await Promise.all([ fetchJSON('status.json'), fetchJSON('windows.json') ]);
    // Fallback: si windows.json est vide, synthétiser depuis meta.window des spots
    let winData = windows;
    if (!winData || !Array.isArray(winData.windows) || winData.windows.length === 0) {
      const synthesized = [];
      for (const file of Object.keys(spotConfig)) {
        const js = await fetchJSON(file);
        const w  = js?.meta?.window;
        if (w?.start_local && w?.end_local) {
          synthesized.push({
            dest_slug: file,
            dest_name: spotConfig[file]?.name || file,
            windows: [{
              start: w.start_local,
              end:   w.end_local,
              confidence: 'medium',
              confidence_score: null,
              models: js?.meta?.sources ? Object.keys(js.meta.sources) : []
            }]
          });
        }
      }
      winData = { generated_at: new Date().toISOString(), windows: synthesized };
    }

    const reasonsRows = (window.FABLE?.debugReasons) ? await FABLE.debugReasons(Object.keys(spotConfig)) : [];

    // Header
    const ok = status && (status.all_fresh || status.status === 'ok');
    $('#hc').className = 'status ' + (ok ? 'ok' : 'warn');
    $('#hc').textContent = t(ok ? 'status_ok' : 'status_stale');
    // Petit “pulse” visuel quand le statut est OK
    if (ok) {
      $('#hc').classList.remove('pulse'); // reset si encore présent
      void $('#hc').offsetWidth;          // reflow pour relancer l'anim
      $('#hc').classList.add('pulse');
    }

    const gen = winData?.generated_at || status?.generated_at || null;
    $('#gen').textContent = `${t('updated')}: ${gen ? fmtLocal(gen) : '...'}`;

    // Fenêtres GO + badges sources/spreads
    const winsDiv = $('#wins');
    const isSimplified = document.body.classList.contains('simplified-view');
    const winsCard = document.querySelector('.card.wins');
    const nowWinsKey = new Set();

    const winItems = (winData?.windows || [])
      .flatMap(dest => (dest.windows||[]).map(seg => {
        const cat = String(seg.category || dest.category || '').toLowerCase();
        const isFamilyDay  = cat ? (cat === 'family')     : isFamilyWindow(seg.start, seg.end);
        const isOffHours = (cat === 'off_hours');
        const isFamilyAny  = isFamilyDay || isOffHours;
        const confKey = ((seg.confidence || dest.confidence) || '').toLowerCase();
        const confText = confKey==='high'?'Haute':confKey==='medium'?'Moy.':confKey==='low'?'Faible':'';
        const confScore = (typeof seg.confidence_score==='number') ? Math.round((seg.confidence_score<=1? seg.confidence_score*100 : seg.confidence_score)) : null;
        const confBadge = confText ? `<span class="conf ${confKey}" title="${t('conf_title',confText,confScore)}">${confText}${confScore!=null?' · '+confScore:''}</span>` : '';

        // sources/spreads
        const models = seg.models || dest.models || [];
        const spreads = seg.spreads || dest.spreads || {};
        const spreadsTxt = [];
        if (typeof spreads.wind_kmh === 'number') spreadsTxt.push(`±${spreads.wind_kmh} km/h`);
        if (typeof spreads.hs_m === 'number')     spreadsTxt.push(`±${spreads.hs_m} m`);
        const srcBadge = (models.length||spreadsTxt.length)
          ? `<div class="small" style="margin-top:4px;opacity:.9">${models.length?('<b>Src:</b> '+models.join('/')):''}${spreadsTxt.length?(' &nbsp; <b>Δ:</b> '+spreadsTxt.join(' / ')):''}</div>`
          : '';

        const key = `${dest.dest_slug||dest.dest_name}|${seg.start}|${seg.end}`;
        const goTxt = isOffHours ? 'GO (hors horaires)' : (isFamilyDay ? 'FAMILY GO' : 'EXPERT GO');
        const goCls = isOffHours ? 'family' : (isFamilyDay ? 'family' : 'expert');
        nowWinsKey.add(key);
        
        return {
          isFamilyDay,
          isOffHours,
          dest_slug: dest.dest_slug,
          html: `<div class="window-line ${(!isFamilyDay)?'expert-only':''}"
                          data-slug="${dest.dest_slug||''}" data-start="${seg.start||''}" data-end="${seg.end||''}">
                  <div class="title">${dest.dest_name} <span class="go ${goCls}">${goTxt}</span> ${confBadge}</div>
                  <div class="small">${fmtFriendly(seg.start)} ⟷ ${fmtFriendly(seg.end)} ⟷ ${Math.round((new Date(seg.end)-new Date(seg.start))/36e5)} h</div>
                  ${srcBadge}
                </div>`
        };
      }))
      .filter(x => isSimplified ? x.isFamilyDay : true);
    
    winsDiv.innerHTML = winItems.length ? winItems.map(x=>x.html).join('') : `<span class="small">${t('none_windows')}</span>`;
    // Alerte douce si nouvelles fenêtres
    let hasNew=false; nowWinsKey.forEach(k=>{ if(!lastWinsKey.has(k)) hasNew=true; });
    lastWinsKey = nowWinsKey;
    if(hasNew && winItems.length){ ding(); flash(winsCard); }
    
    /* ──────────────────────────────────────────────────────────
       Corridors : mode "focus sur clic"
       - aucun corridor par défaut
       - 1 seul corridor quand on clique une .window-line
       - tooltip : distance km/NM + vent aller/retour
       - petite animation le long de la ligne
       ────────────────────────────────────────────────────────── */
    corridorLayer.clearLayers();
    
    // Binder une seule fois le handler sur #wins
    if (!winsDiv.dataset.corridorBound) {
      winsDiv.dataset.corridorBound = '1';
    winsDiv.addEventListener('click', async (e)=>{
      const cardEl = e.target.closest('.window-line');
      if(!cardEl) return;
    
      // selection + keep in view
      document.querySelectorAll('.window-line.select').forEach(n=>n.classList.remove('select'));
      cardEl.classList.add('select');
      cardEl.scrollIntoView({ block:'nearest', behavior:'smooth' });
    
      const slug  = cardEl.dataset.slug;
      const start = cardEl.dataset.start;
      const end   = cardEl.dataset.end;
      if(!slug || !start || !end) return;
    
      const originFile='gammarth-port.json';
      const origin = spotConfig[originFile];
      const dest   = spotConfig[slug];
      if(!origin || !dest) return;
    
      corridorLayer.clearLayers();
    
      // Clicking home: no corridor, just a local note
      if (slug === originFile) {
        document.querySelectorAll('.tripline').forEach(n=>n.remove());
        cardEl.insertAdjacentHTML('beforeend',
          `<div class="small tripline"><div class="row">⚓ <span class="k">Sortie locale</span> <span class="v">depuis le port (pas de transit)</span></div></div>`
        );
        map.setView([origin.lat, origin.lon], 14, {animate:true});
        return;
      }
    
      const ACCENT = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#4cc9f0';
    
      // Single dashed corridor
      const lineAB = L.polyline([[origin.lat,origin.lon],[dest.lat,dest.lon]],{
        color:ACCENT, weight:3, opacity:.9, dashArray:'6,6'
      }).addTo(corridorLayer);
    
      // Neutral midpoint badge only
      const mid=[(origin.lat+dest.lat)/2,(origin.lon+dest.lon)/2];
      L.marker(mid,{
        icon: L.divIcon({ className:'anchor-badge', html:'⛵ 1–1.5 h (transit)', iconSize:[120,24], iconAnchor:[60,12] }),
        interactive:false
      }).addTo(corridorLayer);
    
      // Distance + winds
      const dkm = distKm(origin, dest);
      const dnm = dkm / KM_PER_NM;
    
      const wGo  = await windAt(slug, start);        // wind at destination (start)
      const wRet = await windAt(originFile, end);     // wind at port (end)
    
      const arrowFor = c => ({N:'↑',NNE:'↑',NE:'↗',ENE:'↗',E:'→',ESE:'↘',SE:'↘',SSE:'↓',S:'↓',SSW:'↓',SW:'↙',WSW:'↙',W:'←',WNW:'↖',NW:'↖',NNW:'↑'})[c] || '•';
      const windTxt = (o)=>{
        if(!o || (o.spd==null && o.dir==null)) return '—';
        const cardinal = o.dir!=null ? degToCardinal(o.dir) : null;
        const arr  = cardinal ? arrowFor(cardinal) : '';
        const deg  = o.dir!=null ? ` ${Math.round(o.dir)}°` : '';
        const lab  = cardinal ? ` ${cardinal}` : '';
        const spd  = o.spd!=null ? `${Math.round(o.spd)} km/h` : '';
        return `${spd}${deg}${lab?` (${arr} ${lab})`:''}`.trim();
      };
    
      // Rich summary inside the selected card (remove any previous)
      document.querySelectorAll('.tripline').forEach(n=>n.remove());
      const originName = spotConfig[originFile].name;
      cardEl.insertAdjacentHTML('beforeend', `
        <div class="tripline">
          <div class="row">⛵ <span class="k">1–1.5 h</span> <span class="v">• <b>${originName} → ${dest.name}</b> · 📏 ${dkm.toFixed(1)} km · ${dnm.toFixed(1)} NM</span></div>
          <div class="row">🟢 <span class="k">Aller</span> <span class="v">${windTxt(wGo)}</span></div>
          <div class="row">🔵 <span class="k">Retour</span> <span class="v">${windTxt(wRet)}</span></div>
        </div>
      `);
    
      // viewport + animation out & back
      map.fitBounds(lineAB.getBounds(), {padding:[30,30]});
      await animateAlong(lineAB);                          // aller
      const lineBA = L.polyline([[dest.lat,dest.lon],[origin.lat,origin.lon]],{
        color:ACCENT, weight:3, opacity:.35, dashArray:'6,6'
      }).addTo(corridorLayer);
      await new Promise(r=>setTimeout(r, 300));            // tiny pause
      await animateAlong(lineBA);                          // retour
    });

      
    }
    
    /* ──────────────────────────────────────────────────────────
       Index "flags par spot" pour clarifier les avertissements
       ────────────────────────────────────────────────────────── */
    const spotFlags = new Map();
    (winData?.windows || []).forEach(dest=>{
      (dest.windows || []).forEach(seg=>{
        const cat = String(seg.category || dest.category || '').toLowerCase();
        const slug = dest.dest_slug;
        if (!slug) return;
        const f = spotFlags.get(slug) || { day:false, off:false };
        if (cat === 'off_hours') f.off = true;
        else if (cat === 'family' || isFamilyWindow(seg.start, seg.end)) f.day = true;
        spotFlags.set(slug, f);
      });
    });

    
    // Avertissements (No-GO) — icône/sevérité + raison principale
    const reasonsDiv = $('#reasons');
    if (Array.isArray(reasonsRows) && reasonsRows.length) {
      const rowsHTML = reasonsRows.map(r=>{
       // prefer Family line if present
      const familyRaw = String(r.family||'').trim();
      const expertRaw = String(r.expert||'').trim();
      const useFamily = !!familyRaw;
      const raw = useFamily ? familyRaw : expertRaw;
      
      // Pretty ISO → "samedi 11:00" / "Saturday 11:00" (capitalized)
      const prettifyDates = s =>
        s.replace(/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}/g, iso => {
          const d = new Date(iso);
          if (isNaN(d)) return iso;
          const str = d.toLocaleString(LOCALES[LANG]||'fr-FR',
            { weekday:'long', hour:'2-digit', minute:'2-digit', hour12:false });
          return str.replace(/^\p{L}/u, ch => ch.toUpperCase());
        });
      
      // cleanse + pretty
      const cleanedBase = raw.replace(/^[✗✓⚠🚫✅]\s*/,'')
                             .replace(/\s*\(([^)]+\.json)\)\s*$/,'')
                             .trim();
      const cleaned = prettifyDates(cleanedBase);
      const main = cleaned.split(/;|·|\||\/|—|--|, /)[0].trim() || cleaned;
      
      // file (to read flags)
      const m = /\(([^)]+\.json)\)\s*$/.exec(r.spot||'');
      const file = m ? m[1] : null;
      const flags = file ? spotFlags.get(file) : null;
      
      // severity + icon (check original raw)
      let sev = 'warn', icon = '⚠️';
      if (/^[✗🚫]/.test(raw)) { sev='bad';  icon='🚫'; }
      else if (/^[✓✅]/.test(raw)) { sev='ok'; icon='✅'; }
      
      // scope label
      const scope = useFamily ? ' (journée 08h–21h)' : ' (expert)';
      const offNote = (useFamily && flags?.off) ? ' · fenêtres hors horaires disponibles' : '';
      
      return `<div class="line ${sev}" title="${cleaned}${scope}${offNote}">
                <div class="reason">${icon} ${main}${scope}${offNote}</div>
                <div class="small">${r.spot||''}</div>
              </div>`;

      }).join('');
    
      // Filtrer les entrées ✓ OK afin de ne montrer que les avertissements
      const _tmp = document.createElement('div');
      _tmp.innerHTML = rowsHTML;
      _tmp.querySelectorAll('.line.ok').forEach(n=>n.remove());
      reasonsDiv.innerHTML = _tmp.innerHTML;
    } else {
      reasonsDiv.innerHTML = `<span class="small">${t('reasons_unavailable')}</span>`;
    }

    // Radar des spots + sparklines + bouton Info...
    const filesTableBody = $('#files tbody');
    filesTableBody.innerHTML = Object.entries(spotConfig).map(([file,{name}])=>{
      const entry = status?.files?.find(s=>s.path===file);
      const fresh = isFresh(entry, gen);
      return `<tr data-file="${file}">
        <td>
          <a href="#" data-file="${file}">${name}</a>
          <button class="btn-mini expert-only why" type="button" data-file="${file}">Info...</button>
          <span class="spark expert-only" data-file="${file}"></span>
        </td>
        <td>
          <span class="status-val ${fresh?'ok':'warn'}" title="${fmtLocal(entry?.modified)}">
            ${t(fresh?'fresh':'stale')}
          </span>
        </td>
      </tr>`;
    }).join('');


    // Rendu sparklines (séquentiel pour éviter les freezes)
    for(const el of document.querySelectorAll('.spark[data-file]')){
      try{
        const js = await fetchJSON(el.dataset.file);
        const hours = Array.isArray(js?.hours) ? js.hours.slice(-12) : [];
        if(!hours.length){ el.innerHTML=''; continue; }
        const wind = hours.map(h=>h?.wind_kmh);
        const gust = hours.map(h=>h?.gust_kmh);
        const hs   = hours.map(h=>h?.hs_m);
        const vmax = Math.max(...wind.map(Number).filter(Number.isFinite), ...gust.map(Number).filter(Number.isFinite), 1);
        el.innerHTML = sparklineSVG([wind,gust],{max:vmax,colors:['var(--fg)','var(--muted)']})
                     + sparklineSVG([hs],{colors:['var(--accent)']});
        const lw = wind.map(Number).filter(Number.isFinite).slice(-1)[0];
        const lg = gust.map(Number).filter(Number.isFinite).slice(-1)[0];
        const lh =  hs.map(Number).filter(Number.isFinite).slice(-1)[0];
        el.title = [Number.isFinite(lw)?`Vent: ${lw} km/h`:null, Number.isFinite(lg)?`Raf.: ${lg} km/h`:null, Number.isFinite(lh)?`Hs: ${lh} m`:null].filter(Boolean).join(' · ');
      }catch{ el.innerHTML=''; }
    }

    // Infobulles "Info..." (reasons mappés par fichier)
    const reasonsByFile = new Map((reasonsRows||[]).map(r=>{
      const m=/\(([^)]+\.json)\)\s*$/.exec(r.spot||''); return m ? [m[1], r] : [null,null];
    }).filter(x=>x[0]));
    const showTip = (btn)=>{
      const file = btn.dataset.file;
      const r = reasonsByFile.get(file);
      tipEl.innerHTML = `<div class="hdr">${spotConfig[file]?.name||file}</div>
                         <div class="row"><b>Family:</b> ${r?.family||'—'}</div>
                         <div class="row"><b>Expert:</b> ${r?.expert||'—'}</div>`;
      const rect = btn.getBoundingClientRect();
      tipEl.style.left = `${window.scrollX + rect.left + rect.width + 8}px`;
      tipEl.style.top  = `${window.scrollY + rect.top - 6}px`;
      tipEl.style.display = 'block';
    };
    document.querySelectorAll('button.why').forEach(btn=>{
      btn.addEventListener('mouseenter', ()=>showTip(btn));
      btn.addEventListener('mouseleave', hideTip);
    });

    // Liens bruts
    const ICON = { 'gammarth-port.json':'⚓','sidi-bou-said.json':'⛵','ghar-el-melh.json':'🏝️','ras-fartass.json':'🌊','el-haouaria.json':'🪁','windows.json':'🪟','status.json':'📊','index.json':'📑','rules.normalized.json':'⚖️' };
    const createLink = f => `<li><span style="display:inline-block;width:1.5em;">${ICON[f]||'•'}</span><a href="./${f}">${f}</a></li>`;
    const systemLinks = ['windows.json','status.json','index.json','rules.normalized.json'];
    $('#raw-links-list').innerHTML =
      WANT_SPOTS.map(([,f])=>createLink(f)).join('') +
      '<li style="border-top:1px solid var(--br);margin:6px 0;"></li>' +
      systemLinks.map(createLink).join('');

    // Marqueurs carte
    const spotStatus = {};
    (winData?.windows || []).forEach(dest=>{ if(dest.windows?.length>0) spotStatus[dest.dest_slug]='green'; });
    Object.keys(spotConfig).forEach(file=>{
      if(spotStatus[file]!=='green'){ const entry=status?.files?.find(s=>s.path===file); spotStatus[file] = isFresh(entry,gen) ? 'yellow' : 'red'; }
    });

    // après la carte
    spotsLayer.clearLayers();
    const createIcon = (color,isMain)=> L.divIcon({className:`custom-div-icon ${isMain?'main-port-icon':''}`, html:`<div style="background-color:${color};" class="marker-pin"></div><div class="marker-pulse"></div>`, iconSize:[30,42], iconAnchor:[15,42]});
    for(const file in spotConfig){
      const s=spotConfig[file], isMain = file==='gammarth-port.json', st = spotStatus[file];
      const color = isMain ? 'var(--accent)' : (st==='green'?'var(--ok)':(st==='yellow'?'var(--warn)':'var(--bad)'));
      const text  = isMain ? t('principal_port') : t(`go_popup.${st}`);
      L.marker([s.lat,s.lon],{icon:createIcon(color,isMain),zIndexOffset:isMain?1000:0}).addTo(spotsLayer).bindPopup(`<b>${s.name}</b><br>${text}`);
    }

    $('#dashboard-content').classList.remove('updating');
    fitToViewport();
    map.invalidateSize();  // important quand la hauteur de la carte change
  }

  // Délégation clics dans le tableau (pan sur spot)
  $('#files tbody').addEventListener('click',(e)=>{
    const a=e.target.closest('a[data-file]'); if(a){ e.preventDefault(); window.panToFile(a.dataset.file); }
  });

  // Ajuste la mise en page pour que la page tienne sans scroll
  function fitToViewport(){
    const root   = document.documentElement;
    const vh     = window.innerHeight;
    const header = document.querySelector('header')?.offsetHeight || 0;
    const footer = document.querySelector('footer')?.offsetHeight || 0;
  
    // Hauteur dispo pour (carte + cards)
    const available = Math.max(300, vh - header - footer - 28);
    // ~45% pour la carte, bornée
    const targetMap = Math.round(available * 0.45);
    const mapH = Math.max(260, Math.min(520, targetMap));
    root.style.setProperty('--map-h', mapH + 'px');
  
    // Si un petit overflow persiste, on compense
    const overflow = document.documentElement.scrollHeight - vh;
    if (overflow > 0) {
      root.style.setProperty('--map-h', Math.max(240, mapH - overflow - 8) + 'px');
    }
  }
 
  function tuneFullscreenOverflow(){
    const body = document.body;
    const needScroll = document.documentElement.scrollHeight > window.innerHeight + 1;
     if (document.fullscreenElement) {
      body.style.overflow = needScroll ? 'auto' : 'hidden';
    } else {
      // On the TV (non-fullscreen), we never want the page scrollbar
      body.style.overflow = 'hidden';
    }
  }
  let _resizeT;
  const safeResize = () => {
    clearTimeout(_resizeT);
    _resizeT = setTimeout(()=>{ fitToViewport(); try{ map.invalidateSize(); }catch{} }, 80);
  };
  window.addEventListener('resize', () => { tuneFullscreenOverflow(); safeResize(); });
  document.addEventListener('fullscreenchange', () => { tuneFullscreenOverflow(); safeResize(); });

  tuneFullscreenOverflow();

  // Boucle de vie
  await updateDashboard();
  fitToViewport();
  let countdown = REFRESH_INTERVAL_SECONDS;
  setInterval(()=>{ countdown=(countdown<=1)?REFRESH_INTERVAL_SECONDS:countdown-1; $('#refresh-timer').textContent=t('next_refresh',countdown); },1000);
  setInterval(updateDashboard, REFRESH_INTERVAL_SECONDS*1000);
})();
</script>
</body>
</html>
