<!doctype html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>TABLEAU DE BORD FABLE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
 
  <style>
  .anchor-badge{ pointer-events:none; }
    :root{
      --bg:#0b1020; --fg:#e8eef6; --muted:#a6b7c9; --accent:#4cc9f0;
      --ok:#2dd4bf; --warn:#f59e0b; --bad:#ef4444; --card:#0f172a; --br:#23304a;
      --section:#9ad9ff; --shadow: 0 1px 0 rgba(255,255,255,.03) inset, 0 6px 20px rgba(0,0,0,.35);
      --link:#7dd3fc; --pill-bg:#0d1a2b;
    }
    [data-theme="light"]{
      --bg:#f7fbff; --fg:#0b1424; --muted:#475569; --accent:#0ea5e9;
      --ok:#2dd4bf; --warn:#b45309; --bad:#b91c1c; --card:#ffffff; --br:#d9e1ea;
      --section:#0ea5e9; --shadow: 0 1px 0 rgba(0,0,0,.03) inset, 0 6px 18px rgba(2,6,23,.08);
      --link:#0284c7; --pill-bg:#f1f5f9;
    }
    [data-theme="nautical"] {
      --bg: #fdfdfd; --fg: #0a2240; --muted: #5b6a7e; --accent: #0077b6;
      --ok: #1a936f; --warn: #f78c2a; --bad: #c83e4d; --card: #ffffff; --br: #e1e8f0;
      --section:#005b96; --shadow: 0 4px 12px rgba(10,34,64,.08);
      --link:#0077b6; --pill-bg:#f0f5fa;
    }

    html,body{min-height:100%}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      margin:0;
      padding:24px;
      background:var(--bg);
      color:var(--fg);
      font-size: 1.05rem;
      min-height:100vh;
    }
    @supports (height: 100dvh) { body{ min-height:100dvh; } }

    html:fullscreen body{ padding:16px; overflow:auto; }

    #dashboard-content{transition:opacity .5s ease-in-out}
    #dashboard-content.updating{opacity:.3}

    .layout-grid{ display:grid; gap:16px; }
    .card{border:1px solid var(--br);background:var(--card);padding:16px;border-radius:14px; box-shadow: var(--shadow); overflow-y:auto; scrollbar-width:thin; }
    .card h3{font-size:1.15rem; color:var(--section); display:flex; align-items:center; gap:8px; justify-content: space-between;}

    /* scrollbar customisation */
    .card::-webkit-scrollbar{width:6px}
    .card::-webkit-scrollbar-thumb{background:var(--muted);border-radius:6px}

    .window-line{padding:10px 12px;border:1px solid var(--br);border-radius:12px;margin-bottom:8px}
    .window-line .title{font-weight:700; font-size: 1.05rem; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .go{display:inline-block;border-radius:10px;padding:2px 8px;margin-left:8px;font-weight:800}
    .go.family{background:var(--ok); color:#04110a}
    .go.expert{background:#f59e0b; color:#160f04}
    .conf{border:1px solid var(--br);background:var(--pill-bg);border-radius:999px;padding:2px 8px;margin-left:8px;font-weight:700;font-size:.82rem;color:var(--muted);white-space:nowrap}
    .conf.high{color:var(--ok)} .conf.medium{color:var(--warn)} .conf.low{color:var(--bad)}

    /* header layout */
    .app-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
    .hdr-tools{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    /* FenÃªtres split */
    .wins-tabs{display:flex;gap:8px;margin-bottom:8px}
    .wins-tabs button{flex:1;padding:6px 10px;border:1px solid var(--br);background:var(--pill-bg);color:var(--muted);border-radius:8px;cursor:pointer;font-weight:600}
    .wins-tabs button.active{background:var(--accent);color:#041019}
  </style>
</head>
<body>
<header class="app-header">
  <h1>ðŸ§­ FABLE: Tableau de Bord</h1>
  <div class="hdr-tools">
    <span id="gen" class="pill" aria-live="polite"></span>
    <button id="viewToggleBtn" class="btn">Vue SimplifiÃ©e</button>
    <div id="themeToggle" class="toggle" title="ThÃ¨me">
      <button data-theme="dark" aria-pressed="false">ðŸŒ™</button>
      <button data-theme="nautical" aria-pressed="false">âš“</button>
    </div>
    <button id="muteBtn" class="btn" title="Alerte sonore">ðŸ””</button>
    <div id="langToggle" class="toggle" title="Langue">
      <button data-lang="fr" aria-pressed="false">FR</button>
      <button data-lang="en" aria-pressed="false">EN</button>
    </div>
    <span id="hc" class="status warn" role="status">Statut: â€¦</span>
    <button id="fullscreenBtn" class="btn" title="Plein Ã©cran">â›¶</button>
  </div>
</header>
<div id="dashboard-content">
  <div id="map" aria-label="Carte des spots"></div>

  <div class="layout-grid threecol">
    <!-- 1) FenÃªtres -->
    <div class="card wins">
      <h3>
        <span>ðŸªŸ FenÃªtres de Navigation</span>
        <button id="resetMapBtnTop" class="btn" title="Vue initiale">ðŸ§­</button>
      </h3>
      <div class="wins-tabs">
        <button id="tabFamily" class="active">FAMILY GO</button>
        <button id="tabExpert">EXPERT GO</button>
      </div>
      <div id="winsFamily">Chargementâ€¦</div>
      <div id="winsExpert" style="display:none">Chargementâ€¦</div>
    </div>

    <!-- 2) Avertissements (No-GO) -->
    <div class="card conditions">
      <h3><span>ðŸš¦ Avertissements (No-GO)</span></h3>
      <div id="reasons">Chargementâ€¦</div>
    </div>

    <!-- 3) Radar des Spots -->
    <div class="card radar expert-only">
      <h3>
        <span>ðŸ“¡ Radar des Spots</span>
        <button id="resetMapBtn" class="btn" title="Vue initiale">ðŸ”„</button>
      </h3>
      <div class="table-wrap">
        <table id="files">
          <thead><tr><th>Spot</th><th>Statut</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <details class="sub" style="margin-top:16px;">
        <summary>ðŸ“š DonnÃ©es Brutes</summary>
        <ul id="raw-links-list"></ul>
      </details>
    </div>
  </div>
</div>

<footer>
  <p><span id="tz" class="small"></span><span id="refresh-timer"></span></p>
</footer>

<div id="tooltip" class="tip" style="display:none;" role="tooltip"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="./reasons-debug.js"></script>
<script>
// Tab switching
const tabFamily=document.getElementById('tabFamily');
const tabExpert=document.getElementById('tabExpert');
const winsFamily=document.getElementById('winsFamily');
const winsExpert=document.getElementById('winsExpert');
function activate(tab){
  const fam=tab==='family';
  tabFamily.classList.toggle('active',fam);
  tabExpert.classList.toggle('active',!fam);
  winsFamily.style.display=fam?'block':'none';
  winsExpert.style.display=fam?'none':'block';
}

tabFamily?.addEventListener('click',()=>activate('family'));
tabExpert?.addEventListener('click',()=>activate('expert'));

// Hook into updateDashboard after fetch
window.renderWindows=function(windows){
  const grouped=new Map();
  (windows||[]).forEach(dest=>{
    const list=(dest.windows||[]).map(seg=>({dest,seg}));
    if(!grouped.has(dest.dest_name)) grouped.set(dest.dest_name,[]);
    grouped.get(dest.dest_name).push(...list);
  });
  const renderWin=({dest,seg})=>{
    const family=isFamilyWindow(seg.start,seg.end);
    const confKey=((seg.confidence||dest.confidence)||'').toLowerCase();
    const confText=confKey==='high'?'Haute':confKey==='medium'?'Moy.':confKey==='low'?'Faible':'';
    const confScore=(typeof seg.confidence_score==='number')?Math.round((seg.confidence_score<=1? seg.confidence_score*100:seg.confidence_score)):null;
    const confBadge=confText?`<span class="conf ${confKey}">${confText}${confScore!=null?' Â· '+confScore:''}</span>`:'';
    return `<div class="window-line"><div class="title">${dest.dest_name} ${confBadge}</div><div class="small">${seg.start} â†’ ${seg.end}</div></div>`;
  };
  let famHTML='',expHTML='';
  grouped.forEach((items)=>{
    famHTML+=items.filter(r=>isFamilyWindow(r.seg.start,r.seg.end)).map(renderWin).join('');
    expHTML+=items.filter(r=>!isFamilyWindow(r.seg.start,r.seg.end)).map(renderWin).join('');
  });
  winsFamily.innerHTML=famHTML||'<span class="small">Aucune fenÃªtre</span>';
  winsExpert.innerHTML=expHTML||'<span class="small">Aucune fenÃªtre</span>';
}
</script>
<script>
(function(){
  const REFRESH_INTERVAL_SECONDS = 600;
  const MOCK = new URLSearchParams(location.search).has('mock');
  const I18N = {fr:{status_ok:"Statut: OK",status_stale:"Statut: DonnÃ©es anciennes",updated:"Mise Ã  jour",reasons_unavailable:"Raisons indisponibles.",none_windows:'Aucune fenÃªtre "GO" dÃ©tectÃ©e.',fresh:"Frais",stale:"Ancien",next_refresh:s=>`Prochaine MAJ dans ${s}s.`,principal_port:"Port Principal",go_popup:{green:"FenÃªtre 'GO' !",yellow:"DonnÃ©es Ã  jour",red:"DonnÃ©es anciennes"},conf_title:(t,s)=>`Confiance: ${t}${s!=null?' Â· '+s+'%':''}`},en:{status_ok:"Status: OK",status_stale:"Status: Stale data",updated:"Updated",reasons_unavailable:"Reasons unavailable.",none_windows:'No "GO" window detected.',fresh:"Fresh",stale:"Stale",next_refresh:s=>`Next refresh in ${s}s.`,principal_port:"Main Port",go_popup:{green:"GO window!",yellow:"Data up to date",red:"Stale data"},conf_title:(t,s)=>`Confidence: ${t}${s!=null?' Â· '+s+'%':''}`},};
  const LOCALES = { fr:'fr-FR', en:'en-GB' };
  const spotConfig = {'gammarth-port.json':{name:'Gammarth Port',lat:36.921,lon:10.310},'sidi-bou-said.json':{name:'Sidi Bou SaÃ¯d',lat:36.865,lon:10.351},'ghar-el-melh.json':{name:'Ghar el Melh',lat:37.177,lon:10.280},'ras-fartass.json':{name:'Ras Fartass',lat:36.877,lon:10.613},'el-haouaria.json':{name:'El Haouaria',lat:37.063,lon:11.008}};
  const INITIAL_MAP_VIEW = { center:[36.95,10.6], zoom:9 };
  let LANG = localStorage.getItem('lang') || 'fr'; let muted = localStorage.getItem('mute')==='1';
  const $=s=>document.querySelector(s); const t=(path,...args)=>{const d=I18N[LANG]||I18N.fr; const v=path.split('.').reduce((o,k)=>(o||{})[k],d); return typeof v==='function'?v(...args):(v??path);};
  const fmtLocal=iso=> iso? new Date(iso).toLocaleString(LOCALES[LANG]||'fr-FR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}):'';
  const fmtFriendly=iso=> iso? new Date(iso).toLocaleString(LOCALES[LANG]||'fr-FR',{weekday:'long',hour:'numeric',minute:'2-digit',hour12:false}):'';
  const fetchJSON=async(path)=>{ try{ const r=await fetch(path,{cache:'no-store'}); if(r.ok) return r.json(); }catch{} if(!MOCK) return null; if(path.endsWith('status.json')){ return { status:'ok', all_fresh:true, generated_at:new Date().toISOString(), files:[{path:'gammarth-port.json',modified:new Date(Date.now()-5*60*1000).toISOString()},{path:'sidi-bou-said.json',modified:new Date(Date.now()-30*60*1000).toISOString()},{path:'ghar-el-melh.json',modified:new Date(Date.now()-150*60*1000).toISOString()},{path:'ras-fartass.json',modified:new Date(Date.now()-10*60*1000).toISOString()},{path:'el-haouaria.json',modified:new Date(Date.now()-240*60*1000).toISOString()}]}; } if(path.endsWith('windows.json')){ const now=Date.now(), iso=t=>new Date(t).toISOString(); return { generated_at: iso(now), windows:[{dest_name:'Sidi Bou SaÃ¯d',dest_slug:'sidi-bou-said.json',windows:[{start:iso(now+1*3600e3),end:iso(now+3*3600e3),confidence:'high',confidence_score:0.92,models:['GFS','WW3'],spreads:{wind_kmh:5,hs_m:0.2}},{start:iso(now+6*3600e3),end:iso(now+8*3600e3),confidence:'medium',confidence_score:0.70}]},{dest_name:'Ghar el Melh',dest_slug:'ghar-el-melh.json',windows:[{start:iso(now+2*3600e3),end:iso(now+5*3600e3),confidence:'low',confidence_score:0.45}]},{dest_name:'El Haouaria',dest_slug:'el-haouaria.json',windows:[{start:iso(now+9*3600e3),end:iso(now+12*3600e3),confidence:'high',confidence_score:0.88}]}]}; } if(/\.json$/.test(path)){ const hours=[...Array(12)].map((_,i)=>({wind_kmh:12+Math.round(6*Math.sin(i/2)), gust_kmh:18+Math.round(8*Math.cos(i/3)), hs_m:+(0.6+0.2*Math.sin(i/4)).toFixed(2)})); return {hours}; } return null; };
  // Map
  const map=L.map('map').setView(INITIAL_MAP_VIEW.center, INITIAL_MAP_VIEW.zoom);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
  const corridorLayer=L.layerGroup().addTo(map);
  // Basic controls
  $('#tz').textContent=`Affichage en ${Intl.DateTimeFormat().resolvedOptions().timeZone}.`;
  (function(){ const langToggle=$('#langToggle'); const setLangUI=l=>{ LANG=l; localStorage.setItem('lang',l); document.documentElement.lang=l; document.documentElement.dir='ltr'; langToggle?.querySelectorAll('button').forEach(b=>{const on=b.dataset.lang===l; b.classList.toggle('active',on); b.setAttribute('aria-pressed',on?'true':'false');}); }; langToggle?.addEventListener('click',e=>{const btn=e.target.closest('button[data-lang]'); if(!btn) return; setLangUI(btn.dataset.lang); updateDashboard();}); setLangUI(LANG); })();
  (function(){ const btn=$('#muteBtn'); const setUI=m=>{ muted=m; localStorage.setItem('mute',m?'1':'0'); if(btn) btn.textContent=m?'ðŸ”•':'ðŸ””'; }; setUI(muted); btn?.addEventListener('click',()=>setUI(!muted));})();
  (function(){ const themes=['dark','nautical']; let theme=localStorage.getItem('theme')||document.documentElement.getAttribute('data-theme')||'dark'; if(!themes.includes(theme)) theme='dark'; const toggle=$('#themeToggle'); function apply(t){ document.documentElement.setAttribute('data-theme',t); localStorage.setItem('theme',t); toggle?.querySelectorAll('button').forEach(b=>{const on=b.dataset.theme===t; b.classList.toggle('active',on); b.setAttribute('aria-pressed',on?'true':'false');}); } toggle?.addEventListener('click',e=>{ const b=e.target.closest('button[data-theme]'); if(!b) return; apply(b.dataset.theme); }); apply(theme); })();
  $('#fullscreenBtn')?.addEventListener('click',()=> document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen());
  $('#viewToggleBtn')?.addEventListener('click',()=>{ const s=document.body.classList.toggle('simplified-view'); $('#viewToggleBtn').textContent=s?'Vue Experte':'Vue SimplifiÃ©e'; updateDashboard(); });
  document.getElementById('resetMapBtnTop')?.addEventListener('click',()=> map.setView(INITIAL_MAP_VIEW.center, INITIAL_MAP_VIEW.zoom, {animate:true}));
  document.getElementById('resetMapBtn')?.addEventListener('click',()=> map.setView(INITIAL_MAP_VIEW.center, INITIAL_MAP_VIEW.zoom, {animate:true}));

  async function updateDashboard(){
    const winsFamily=document.getElementById('winsFamily');
    const winsExpert=document.getElementById('winsExpert');
    const [status, windows] = await Promise.all([ fetchJSON('status.json'), fetchJSON('windows.json') ]);
    const ok = status && (status.all_fresh || status.status==='ok');
    const hc=document.getElementById('hc'); if(hc){ hc.className='status '+(ok?'ok':'warn'); hc.textContent=t(ok?'status_ok':'status_stale'); }
    const gen=windows?.generated_at || status?.generated_at || null; document.getElementById('gen').textContent=`${t('updated')}: ${gen?fmtLocal(gen):'...'}`;
    const grouped=new Map(); (windows?.windows||[]).forEach(dest=>{ const items=(dest.windows||[]).map(seg=>({dest,seg})); grouped.set(dest.dest_name,(grouped.get(dest.dest_name)||[]).concat(items)); });
    const renderWin=({dest,seg})=>{ const family=(function(startIso,endIso){ const s=new Date(startIso), e=new Date(endIso); if(isNaN(s)||isNaN(e)) return true; for(let d=new Date(s); d<=e; d.setHours(d.getHours()+1)){const h=d.getHours(); if(h<8||h>=21) return false;} return true; })(seg.start,seg.end); const confKey=((seg.confidence||dest.confidence)||'').toLowerCase(); const confText=confKey==='high'?'Haute':confKey==='medium'?'Moy.':confKey==='low'?'Faible':''; const score=(typeof seg.confidence_score==='number')?Math.round((seg.confidence_score<=1? seg.confidence_score*100 : seg.confidence_score)):null; const confBadge=confText?`<span class=\"conf ${confKey}\" title=\"${t('conf_title',confText,score)}\">${confText}${score!=null?' Â· '+score:''}</span>`:''; return {family,slug:dest.dest_slug, html:`<div class=\"window-line ${!family?'expert-only':''}\"><div class=\"title\">${fmtFriendly(seg.start)} âŸ· ${fmtFriendly(seg.end)} âŸ· ${Math.round((new Date(seg.end)-new Date(seg.start))/36e5)} h ${confBadge}</div></div>`}; };
    const famHTML=[]; const expHTML=[]; const seenSlugs=new Set();
    grouped.forEach((items,destName)=>{ const r=items.map(renderWin); const fam=r.filter(x=>x.family); const exp=r.filter(x=>!x.family); const header=`<div class=\"window-line\" style=\"border-style:dashed\"><div class=\"title\">${destName}</div></div>`; if(fam.length) famHTML.push(header + fam.map(x=>x.html).join('')); if(exp.length) expHTML.push(header + exp.map(x=>x.html).join('')); r.forEach(x=>{ if(x.slug) seenSlugs.add(x.slug); }); });
    winsFamily.innerHTML=famHTML.join('')||`<span class=\"small\">${t('none_windows')}</span>`;
    winsExpert.innerHTML=expHTML.join('')||`<span class=\"small\">${t('none_windows')}</span>`;
    // corridors
    corridorLayer.clearLayers(); const origin=spotConfig['gammarth-port.json']; const ACCENT=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#4cc9f0'; Array.from(seenSlugs).slice(0,3).forEach(slug=>{ const dest=spotConfig[slug]; if(!dest||!origin) return; L.polyline([[origin.lat,origin.lon],[dest.lat,dest.lon]],{color:ACCENT,weight:3,opacity:.9,dashArray:'6,6'}).addTo(corridorLayer); });
  }
  updateDashboard();
})();
</script>
</body>
</html>
