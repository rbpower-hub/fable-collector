<!doctype html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>TABLEAU DE BORD FABLE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
 
  <style>
  .anchor-badge{ pointer-events:none; }
    :root{
      --bg:#0b1020; --fg:#e8eef6; --muted:#a6b7c9; --accent:#4cc9f0;
      --ok:#2dd4bf; --warn:#f59e0b; --bad:#ef4444; --card:#0f172a; --br:#23304a;
      --section:#9ad9ff; --shadow: 0 1px 0 rgba(255,255,255,.03) inset, 0 6px 20px rgba(0,0,0,.35);
      --link:#7dd3fc; --pill-bg:#0d1a2b;
    }
    [data-theme="light"]{
      --bg:#f7fbff; --fg:#0b1424; --muted:#475569; --accent:#0ea5e9;
      --ok:#2dd4bf; --warn:#b45309; --bad:#b91c1c; --card:#ffffff; --br:#d9e1ea;
      --section:#0ea5e9; --shadow: 0 1px 0 rgba(0,0,0,.03) inset, 0 6px 18px rgba(2,6,23,.08);
      --link:#0284c7; --pill-bg:#f1f5f9;
    }
    [data-theme="nautical"] {
      --bg: #fdfdfd; --fg: #0a2240; --muted: #5b6a7e; --accent: #0077b6;
      --ok: #1a936f; --warn: #f78c2a; --bad: #c83e4d; --card: #ffffff; --br: #e1e8f0;
      --section:#005b96; --shadow: 0 4px 12px rgba(10,34,64,.08);
      --link:#0077b6; --pill-bg:#f0f5fa;
    }

    html,body{min-height:100%}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      margin:0;
      padding:24px;
      background:var(--bg);
      color:var(--fg);
      font-size: 1.05rem;
      min-height:100vh;
    }
    @supports (height: 100dvh) { body{ min-height:100dvh; } }

    html:fullscreen body{ padding:16px; overflow:auto; }

    #dashboard-content{transition:opacity .5s ease-in-out}
    #dashboard-content.updating{opacity:.3}

    .layout-grid{ display:grid; gap:16px; }
    .card{border:1px solid var(--br);background:var(--card);padding:16px;border-radius:14px; box-shadow: var(--shadow); overflow-y:auto; scrollbar-width:thin; }
    .card h3{font-size:1.15rem; color:var(--section); display:flex; align-items:center; gap:8px; justify-content: space-between;}

    /* scrollbar customisation */
    .card::-webkit-scrollbar{width:6px}
    .card::-webkit-scrollbar-thumb{background:var(--muted);border-radius:6px}

    .window-line{padding:10px 12px;border:1px solid var(--br);border-radius:12px;margin-bottom:8px}
    .window-line .title{font-weight:700; font-size: 1.05rem; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .go{display:inline-block;border-radius:10px;padding:2px 8px;margin-left:8px;font-weight:800}
    .go.family{background:var(--ok); color:#04110a}
    .go.expert{background:#f59e0b; color:#160f04}
    .conf{border:1px solid var(--br);background:var(--pill-bg);border-radius:999px;padding:2px 8px;margin-left:8px;font-weight:700;font-size:.82rem;color:var(--muted);white-space:nowrap}
    .conf.high{color:var(--ok)} .conf.medium{color:var(--warn)} .conf.low{color:var(--bad)}

    /* header layout */
    .app-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:12px}
    .hdr-tools{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    /* FenÃªtres split */
    .wins-tabs{display:flex;gap:8px;margin-bottom:8px}
    .wins-tabs button{flex:1;padding:6px 10px;border:1px solid var(--br);background:var(--pill-bg);color:var(--muted);border-radius:8px;cursor:pointer;font-weight:600}
    .wins-tabs button.active{background:var(--accent);color:#041019}
      /* Spot header (group title) and tighter title layout */
    .dest-title{font-weight:800;color:var(--section)}
    .window-line .title{justify-content:flex-start;gap:6px}
</style>
</head>
<body>
<header class="app-header">
  <h1>ðŸ§­ FABLE: Tableau de Bord</h1>
  <div class="hdr-tools">
    <span id="gen" class="pill" aria-live="polite"></span>
    <button id="viewToggleBtn" class="btn">Vue SimplifiÃ©e</button>
    <div id="themeToggle" class="toggle" title="ThÃ¨me">
      <button data-theme="dark" aria-pressed="false">ðŸŒ™</button>
      <button data-theme="nautical" aria-pressed="false">âš“</button>
    </div>
    <button id="muteBtn" class="btn" title="Alerte sonore">ðŸ””</button>
    <div id="langToggle" class="toggle" title="Langue">
      <button data-lang="fr" aria-pressed="false">FR</button>
      <button data-lang="en" aria-pressed="false">EN</button>
    </div>
    <span id="hc" class="status warn" role="status">Statut: â€¦</span>
    <button id="fullscreenBtn" class="btn" title="Plein Ã©cran">â›¶</button>
  </div>
</header>
<div id="dashboard-content">
  <div id="map" aria-label="Carte des spots"></div>

  <div class="layout-grid threecol">
    <!-- 1) FenÃªtres -->
    <div class="card wins">
      <h3>
        <span>ðŸªŸ FenÃªtres de Navigation</span>
        <button id="resetMapBtnTop" class="btn" title="Vue initiale">ðŸ§­</button>
      </h3>
      <div class="wins-tabs">
        <button id="tabFamily" class="active">FAMILY GO</button>
        <button id="tabExpert">EXPERT GO</button>
      </div>
      <div id="winsFamily">Chargementâ€¦</div>
      <div id="winsExpert" style="display:none">Chargementâ€¦</div>
    </div>

    <!-- 2) Avertissements (No-GO) -->
    <div class="card conditions">
      <h3><span>ðŸš¦ Avertissements (No-GO)</span></h3>
      <div id="reasons">Chargementâ€¦</div>
    </div>

    <!-- 3) Radar des Spots -->
    <div class="card radar expert-only">
      <h3>
        <span>ðŸ“¡ Radar des Spots</span>
        <button id="resetMapBtn" class="btn" title="Vue initiale">ðŸ”„</button>
      </h3>
      <div class="table-wrap">
        <table id="files">
          <thead><tr><th>Spot</th><th>Statut</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <details class="sub" style="margin-top:16px;">
        <summary>ðŸ“š DonnÃ©es Brutes</summary>
        <ul id="raw-links-list"></ul>
      </details>
    </div>
  </div>
</div>

<footer>
  <p><span id="tz" class="small"></span><span id="refresh-timer"></span></p>
</footer>

<div id="tooltip" class="tip" style="display:none;" role="tooltip"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script src="./reasons-debug.js"></script>
<script>
// Tab switching
const tabFamily=document.getElementById('tabFamily');
const tabExpert=document.getElementById('tabExpert');
const winsFamily=document.getElementById('winsFamily');
const winsExpert=document.getElementById('winsExpert');
function activate(tab){
  const fam=tab==='family';
  tabFamily.classList.toggle('active',fam);
  tabExpert.classList.toggle('active',!fam);
  winsFamily.style.display=fam?'block':'none';
  winsExpert.style.display=fam?'none':'block';
}

tabFamily?.addEventListener('click',()=>activate('family'));
tabExpert?.addEventListener('click',()=>activate('expert'));

// Hook into updateDashboard after fetch
window.renderWindows=function(windows){
  const grouped=new Map();
  (windows||[]).forEach(dest=>{
    const list=(dest.windows||[]).map(seg=>({dest,seg}));
    if(!grouped.has(dest.dest_name)) grouped.set(dest.dest_name,[]);
    grouped.get(dest.dest_name).push(...list);
  });
  const renderWin=({dest,seg})=>{
    const family=isFamilyWindow(seg.start,seg.end);
    const confKey=((seg.confidence||dest.confidence)||'').toLowerCase();
    const confText=confKey==='high'?'Haute':confKey==='medium'?'Moy.':confKey==='low'?'Faible':'';
    const confScore=(typeof seg.confidence_score==='number')?Math.round((seg.confidence_score<=1? seg.confidence_score*100:seg.confidence_score)):null;
    const confBadge=confText?`<span class="conf ${confKey}">${confText}${confScore!=null?' Â· '+confScore:''}</span>`:'';
    return `<div class="window-line"><div class="title">${dest.dest_name} ${confBadge}</div><div class="small">${seg.start} â†’ ${seg.end}</div></div>`;
  };
  let famHTML='',expHTML='';
  grouped.forEach((items)=>{
    famHTML+=items.filter(r=>isFamilyWindow(r.seg.start,r.seg.end)).map(renderWin).join('');
    expHTML+=items.filter(r=>!isFamilyWindow(r.seg.start,r.seg.end)).map(renderWin).join('');
  });
  winsFamily.innerHTML=famHTML||'<span class="small">Aucune fenÃªtre</span>';
  winsExpert.innerHTML=expHTML.join('')||`<span class=\"small\">${t('none_windows')}</span>`;
  // ---- Radar des Spots (table) ----
  const filesTbody = document.querySelector('#files tbody');
  if (filesTbody) {
    filesTbody.innerHTML = Object.entries(spotConfig).map(([file,{name}])=>{
      const entry = status?.files?.find(s=>s.path===file);
      const fresh = !!entry; // simple proxy with mock or presence
      return `<tr data-file="${file}">
        <td><a href="#" data-file="${file}"><strong>${name}</strong></a></td>
        <td><span class="status-val ${fresh?'ok':'warn'}" title="${fmtLocal(entry?.modified)}">${t(fresh?'fresh':'stale')}</span></td>
      </tr>`;
    }).join('');
  
    // Pan map to marker on click
    filesTbody.addEventListener('click',(e)=>{
      const a=e.target.closest('a[data-file]');
      if(!a) return;
      e.preventDefault();
      const s=spotConfig[a.dataset.file];
      if (s) map.setView([s.lat,s.lon], 12, {animate:true});
    });
  }
  
  // ---- DonnÃ©es Brutes (links) ----
  const ICON = { 'gammarth-port.json':'âš“','sidi-bou-said.json':'â›µ','ghar-el-melh.json':'ðŸï¸','ras-fartass.json':'ðŸŒŠ','el-haouaria.json':'ðŸª','windows.json':'ðŸªŸ','status.json':'ðŸ“Š','index.json':'ðŸ“‘','rules.normalized.json':'âš–ï¸' };
  const createLink = f => `<li><span style="display:inline-block;width:1.5em;">${ICON[f]||'â€¢'}</span><a href="./${f}">${f}</a></li>`;
  const systemLinks = ['windows.json','status.json','index.json','rules.normalized.json'];
  const rawList = document.getElementById('raw-links-list');
  if (rawList) {
    rawList.innerHTML =
      Object.keys(spotConfig).map(f=>createLink(f)).join('') +
      '<li style="border-top:1px solid var(--br);margin:6px 0;"></li>' +
      systemLinks.map(createLink).join('');
  }
  
  // ---- Map markers + corridors ----
  const origin = spotConfig['gammarth-port.json'];
  const ACCENT = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#4cc9f0';
  
  const seenSlugs = new Set();
  (windows?.windows||[]).forEach(d => { if (d.windows?.length) seenSlugs.add(d.dest_slug); });
  
  // draw corridors (limit 3)
  corridorLayer.clearLayers();
  Array.from(seenSlugs).slice(0,3).forEach(slug=>{
    const dest=spotConfig[slug]; if(!dest||!origin) return;
    L.polyline([[origin.lat,origin.lon],[dest.lat,dest.lon]],{color:ACCENT,weight:3,opacity:.9,dashArray:'6,6'}).addTo(corridorLayer);
  });
  
  // remove old markers (keep tiles + corridors)
  map.eachLayer(l=>{ if(l instanceof L.Marker) map.removeLayer(l); });
  
  // markers by status (main port accent; green if any GO; else yellow/red)
  const createIcon=(color,isMain)=> L.divIcon({
    className:`custom-div-icon ${isMain?'main-port-icon':''}`,
    html:`<div style="background-color:${color};" class="marker-pin"></div><div class="marker-pulse"></div>`,
    iconSize:[30,42], iconAnchor:[15,42]
  });
  
  const spotStatus = {};
  (windows?.windows || []).forEach(dest=>{ if(dest.windows?.length>0) spotStatus[dest.dest_slug]='green'; });
  Object.keys(spotConfig).forEach(file=>{
    if (!spotStatus[file]) {
      const entry = status?.files?.find(s=>s.path===file);
      spotStatus[file] = entry ? 'yellow' : 'red';
    }
  });
  
  for (const file in spotConfig){
    const s=spotConfig[file], isMain=(file==='gammarth-port.json'), st=spotStatus[file];
    const color = isMain ? 'var(--accent)' : (st==='green'?'var(--ok)':(st==='yellow'?'var(--warn)':'var(--bad)'));
    const text  = isMain ? t('principal_port') : t(`go_popup.${st}`);
    L.marker([s.lat,s.lon],{icon:createIcon(color,isMain),zIndexOffset:isMain?1000:0})
      .addTo(map)
      .bindPopup(`<b>${s.name}</b><br>${text}`);
  }
  
  // help Leaflet recompute layout after DOM changes (TV/FullScreen)
  setTimeout(()=>{ try{ map.invalidateSize(); }catch{} }, 50);

    // ---- Radar des Spots (table) ----
    const filesTbody = document.querySelector('#files tbody');
    if (filesTbody) {
      filesTbody.innerHTML = Object.entries(spotConfig).map(([file,{name}])=>{
        const entry = status?.files?.find(s=>s.path===file);
        const fresh = !!entry; // simple proxy with mock
        return `<tr data-file=\"${file}\">\n          <td><a href=\"#\" data-file=\"${file}\"><strong>${name}</strong></a></td>\n          <td><span class=\"status-val ${fresh?'ok':'warn'}\" title=\"${fmtLocal(entry?.modified)}\">${t(fresh?'fresh':'stale')}</span></td>\n        </tr>`;
      }).join('');
      filesTbody.addEventListener('click',(e)=>{
        const a=e.target.closest('a[data-file]'); if(!a) return; e.preventDefault(); const s=spotConfig[a.dataset.file]; if(s) map.setView([s.lat,s.lon],12,{animate:true});
      });
    }

    // ---- DonnÃ©es Brutes (links) ----
    const ICON = { 'gammarth-port.json':'âš“','sidi-bou-said.json':'â›µ','ghar-el-melh.json':'ðŸï¸','ras-fartass.json':'ðŸŒŠ','el-haouaria.json':'ðŸª','windows.json':'ðŸªŸ','status.json':'ðŸ“Š','index.json':'ðŸ“‘','rules.normalized.json':'âš–ï¸' };
    const createLink = f => `<li><span style=\\\"display:inline-block;width:1.5em;\\\">${ICON[f]||'â€¢'}</span><a href=\\\"./${f}\\\">${f}</a></li>`;
    const systemLinks = ['windows.json','status.json','index.json','rules.normalized.json'];
    const rawList = document.getElementById('raw-links-list');
    if (rawList) {
      rawList.innerHTML = Object.keys(spotConfig).map(f=>createLink(f)).join('') + '<li style=\\\"border-top:1px solid var(--br);margin:6px 0;\\\"></li>' + systemLinks.map(createLink).join('');
    }

    // ---- Map markers + corridors ----
    const origin = spotConfig['gammarth-port.json'];
    const ACCENT = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#4cc9f0';

    const seenSlugs = new Set();
    (windows?.windows||[]).forEach(d=>{ if(d.windows?.length) seenSlugs.add(d.dest_slug); });
    Array.from(seenSlugs).slice(0,3).forEach(slug=>{
      const dest=spotConfig[slug]; if(!dest||!origin) return;
      L.polyline([[origin.lat,origin.lon],[dest.lat,dest.lon]],{color:ACCENT,weight:3,opacity:.9,dashArray:'6,6'}).addTo(corridorLayer);
    });

    map.eachLayer(l=>{ if(l instanceof L.Marker) map.removeLayer(l); });
    const createIcon=(color,isMain)=> L.divIcon({className:`custom-div-icon ${isMain?'main-port-icon':''}`, html:`<div style=\\\"background-color:${color};\\\" class=\\\"marker-pin\\\"></div><div class=\\\"marker-pulse\\\"></div>`, iconSize:[30,42], iconAnchor:[15,42]});

    const spotStatus={};
    (windows?.windows||[]).forEach(dest=>{ if(dest.windows?.length>0) spotStatus[dest.dest_slug]='green'; });
    Object.keys(spotConfig).forEach(file=>{ if(!spotStatus[file]){ const entry=status?.files?.find(s=>s.path===file); spotStatus[file] = entry ? 'yellow' : 'red'; } });

    for(const file in spotConfig){ const s=spotConfig[file], isMain=(file==='gammarth-port.json'), st=spotStatus[file]; const color=isMain?'var(--accent)':(st==='green'?'var(--ok)':(st==='yellow'?'var(--warn)':'var(--bad)')); const text=isMain?t('principal_port'):t(`go_popup.${st}`); L.marker([s.lat,s.lon],{icon:createIcon(color,isMain),zIndexOffset:isMain?1000:0}).addTo(map).bindPopup(`<b>${s.name}</b><br>${text}`); }

    setTimeout(()=>{ try{ map.invalidateSize(); }catch{} }, 50);

    corridorLayer.clearLayers(); const filesTbody = document.querySelector('#files tbody');
    if (filesTbody) {
      filesTbody.innerHTML = Object.entries(spotConfig).map(([file,{name}])=>{
        const entry = status?.files?.find(s=>s.path===file);
        const fresh = !!entry; // simple proxy with mock
        return `<tr data-file="${file}">
          <td><a href="#" data-file="${file}"><strong>${name}</strong></a></td>
          <td><span class="status-val ${fresh?'ok':'warn'}" title="${fmtLocal(entry?.modified)}">${t(fresh?'fresh':'stale')}</span></td>
        </tr>`;
      }).join('');
      filesTbody.addEventListener('click',(e)=>{
        const a=e.target.closest('a[data-file]'); if(!a) return; e.preventDefault(); const s=spotConfig[a.dataset.file]; if(s) map.setView([s.lat,s.lon],12,{animate:true});
      });
    }

    // ---- DonnÃ©es Brutes (links) ----
    const ICON = { 'gammarth-port.json':'âš“','sidi-bou-said.json':'â›µ','ghar-el-melh.json':'ðŸï¸','ras-fartass.json':'ðŸŒŠ','el-haouaria.json':'ðŸª','windows.json':'ðŸªŸ','status.json':'ðŸ“Š','index.json':'ðŸ“‘','rules.normalized.json':'âš–ï¸' };
    const createLink = f => `<li><span style=\"display:inline-block;width:1.5em;\">${ICON[f]||'â€¢'}</span><a href=\"./${f}\">${f}</a></li>`;
    const systemLinks = ['windows.json','status.json','index.json','rules.normalized.json'];
    const rawList = document.getElementById('raw-links-list');
    if (rawList) {
      rawList.innerHTML = Object.keys(spotConfig).map(f=>createLink(f)).join('') + '<li style=\"border-top:1px solid var(--br);margin:6px 0;\"></li>' + systemLinks.map(createLink).join('');
    }

    // ---- Map markers + corridors ----
    corridorLayer.clearLayers();
    const origin = spotConfig['gammarth-port.json'];
    const ACCENT = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#4cc9f0';

    const seenSlugs = new Set();
    (windows?.windows||[]).forEach(d=>{ if(d.windows?.length) seenSlugs.add(d.dest_slug); });
    Array.from(seenSlugs).slice(0,3).forEach(slug=>{
      const dest=spotConfig[slug]; if(!dest||!origin) return;
      L.polyline([[origin.lat,origin.lon],[dest.lat,dest.lon]],{color:ACCENT,weight:3,opacity:.9,dashArray:'6,6'}).addTo(corridorLayer);
    });

    map.eachLayer(l=>{ if(l instanceof L.Marker) map.removeLayer(l); });
    const createIcon=(color,isMain)=> L.divIcon({className:`custom-div-icon ${isMain?'main-port-icon':''}`, html:`<div style=\"background-color:${color};\" class=\"marker-pin\"></div><div class=\"marker-pulse\"></div>`, iconSize:[30,42], iconAnchor:[15,42]});

    const spotStatus={};
    (windows?.windows||[]).forEach(dest=>{ if(dest.windows?.length>0) spotStatus[dest.dest_slug]='green'; });
    Object.keys(spotConfig).forEach(file=>{ if(!spotStatus[file]){ const entry=status?.files?.find(s=>s.path===file); spotStatus[file] = entry ? 'yellow' : 'red'; } });

    for(const file in spotConfig){ const s=spotConfig[file], isMain=(file==='gammarth-port.json'), st=spotStatus[file]; const color=isMain?'var(--accent)':(st==='green'?'var(--ok)':(st==='yellow'?'var(--warn)':'var(--bad)')); const text=isMain?t('principal_port'):t(`go_popup.${st}`); L.marker([s.lat,s.lon],{icon:createIcon(color,isMain),zIndexOffset=isMain?1000:0}).addTo(map).bindPopup(`<b>${s.name}</b><br>${text}`); }

    setTimeout(()=>{ try{ map.invalidateSize(); }catch{} }, 50);

    // corridors/ corridors
    corridorLayer.clearLayers(); const origin=spotConfig['gammarth-port.json']; const ACCENT=getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()||'#4cc9f0'; Array.from(seenSlugs).slice(0,3).forEach(slug=>{ const dest=spotConfig[slug]; if(!dest||!origin) return; L.polyline([[origin.lat,origin.lon],[dest.lat,dest.lon]],{color:ACCENT,weight:3,opacity:.9,dashArray:'6,6'}).addTo(corridorLayer); });
  }
  updateDashboard();
})();
</script>
</body>
</html>
// ---- Radar des Spots (table) ----
    const filesTbody = document.querySelector('#files tbody');
    if (filesTbody) {
      filesTbody.innerHTML = Object.entries(spotConfig).map(([file,{name}])=>{
        const entry = status?.files?.find(s=>s.path===file);
        const fresh = !!entry; // simple proxy with mock
        return `<tr data-file=\"${file}\">\n          <td><a href=\"#\" data-file=\"${file}\"><strong>${name}</strong></a></td>\n          <td><span class=\"status-val ${fresh?'ok':'warn'}\" title=\"${fmtLocal(entry?.modified)}\">${t(fresh?'fresh':'stale')}</span></td>\n        </tr>`;
      }).join('');
      filesTbody.addEventListener('click',(e)=>{
        const a=e.target.closest('a[data-file]'); if(!a) return; e.preventDefault(); const s=spotConfig[a.dataset.file]; if(s) map.setView([s.lat,s.lon],12,{animate:true});
      });
    }

    // ---- DonnÃ©es Brutes (links) ----
    const ICON = { 'gammarth-port.json':'âš“','sidi-bou-said.json':'â›µ','ghar-el-melh.json':'ðŸï¸','ras-fartass.json':'ðŸŒŠ','el-haouaria.json':'ðŸª','windows.json':'ðŸªŸ','status.json':'ðŸ“Š','index.json':'ðŸ“‘','rules.normalized.json':'âš–ï¸' };
    const createLink = f => `<li><span style=\\\"display:inline-block;width:1.5em;\\\">${ICON[f]||'â€¢'}</span><a href=\\\"./${f}\\\">${f}</a></li>`;
    const systemLinks = ['windows.json','status.json','index.json','rules.normalized.json'];
    const rawList = d// ---- Radar des Spots (table) ----
    const filesTbody = document.querySelector('#files tbody');
    if (filesTbody) {
      filesTbody.innerHTML = Object.entries(spotConfig).map(([file,{name}])=>{
        const entry = status?.files?.find(s=>s.path===file);
        const fresh = !!entry; // simple proxy with mock
        return `<tr data-file=\"${file}\">\n          <td><a href=\"#\" data-file=\"${file}\"><strong>${name}</strong></a></td>\n          <td><span class=\"status-val ${fresh?'ok':'warn'}\" title=\"${fmtLocal(entry?.modified)}\">${t(fresh?'fresh':'stale')}</span></td>\n        </tr>`;
      }).join('');
      filesTbody.addEventListener('click',(e)=>{
        const a=e.target.closest('a[data-file]'); if(!a) return; e.preventDefault(); const s=spotConfig[a.dataset.file]; if(s) map.setView([s.lat,s.lon],12,{animate:true});
      });
    }

    // ---- DonnÃ©es Brutes (links) ----
    const ICON = { 'gammarth-port.json':'âš“','sidi-bou-said.json':'â›µ','ghar-el-melh.json':'ðŸï¸','ras-fartass.json':'ðŸŒŠ','el-haouaria.json':'ðŸª','windows.json':'ðŸªŸ','status.json':'ðŸ“Š','index.json':'ðŸ“‘','rules.normalized.json':'âš–ï¸' };
    const createLink = f => `<li><span style=\\\"display:inline-block;width:1.5em;\\\">${ICON[f]||'â€¢'}</span><a href=\\\"./${f}\\\">${f}</a></li>`;
    const systemLinks = ['windows.json','status.json','index.json','rules.normalized.json'];
    const rawList = document.getElementById('raw-links-list');
    if (rawList) {
      rawList.innerHTML = Object.keys(spotConfig).map(f=>createLink(f)).join('') + '<li style=\\\"border-top:1px solid var(--br);margin:6px 0;\\\"></li>' + systemLinks.map(createLink).join('');
    }

    // proceed to clear and rebuild corridors / markers
    corridorLayer.clearLayers();links-list');
    if (rawList) {
      rawList.innerHTML = Object.keys(spotConfig).map(f=>createLink(f)).join('') + '<li style=\\\"border-top:1px solid var(--br);margin:6px 0;\\\"></li>' + systemLinks.map(createLink).join('');
    }

    // ---- Map markers + corridors ----
    
// corridors
