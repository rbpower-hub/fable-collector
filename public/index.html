<!doctype html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>fable-collector ‚Äî tableau de bord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1020" />
  <style>
    /* ===== Th√®me & palette accessibles (AA/AAA) ===== */
    :root{
      --bg:#0b1020; --fg:#e8eef6; --muted:#a6b7c9; --accent:#4cc9f0;
      --ok:#2dd4bf; --warn:#f59e0b; --bad:#ef4444; --card:#0f172a; --br:#23304a;
      --badge-bg:#16243a; --badge-br:#2b3b59; --pill-bg:#0d1a2b;
      --link:#7dd3fc;
      --shadow: 0 1px 0 rgba(255,255,255,.03) inset, 0 6px 20px rgba(0,0,0,.35);
    }
    [data-theme="light"]{      --bg:#f7fbff; --fg:#0b1424; --muted:#475569; --accent:#0ea5e9;
      --ok:#2dd4bf; --warn:#b45309; --bad:#b91c1c; --card:#ffffff; --br:#d9e1ea;
      --badge-bg:#eef6ff; --badge-br:#d9e7ff; --pill-bg:#f1f5f9; --link:#0284c7;
      --shadow: 0 1px 0 rgba(0,0,0,.03) inset, 0 6px 18px rgba(2,6,23,.08);
    } --warn:#b45309; --bad:#b91c1c; --card:#ffffff; --br:#d9e1ea;
      --badge-bg:#eef6ff; --badge-br:#d9e7ff; --pill-bg:#f1f5f9; --link:#0284c7;
      --shadow: 0 1px 0 rgba(0,0,0,.03) inset, 0 6px 18px rgba(2,6,23,.08);
    }

    /* ===== Base ===== */
    html,body{height:100%}
    body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif; margin:24px; background:var(--bg); color:var(--fg)}
    *{box-sizing:border-box}
    a{color:var(--link); text-decoration: none}
    a:hover{text-decoration: underline}
    h1,h2,h3{margin:0 0 8px 0}
    .sr-only{position:absolute;left:-9999px}

    /* ===== Header ===== */
    header{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:16px}
    header h1{font-size:1.35rem}
    .spacer{flex:1}
    .btn{cursor:pointer; border:1px solid var(--br); background:var(--pill-bg); color:var(--fg); padding:6px 10px; border-radius:9px}

    .pill{border:1px solid var(--br);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:.86rem;background:var(--pill-bg)}
    .status{display:inline-block;border-radius:8px;padding:4px 10px;margin-left:8px;color:#0b1020;font-weight:700}
    .status.ok{background:var(--ok)} .status.warn{background:var(--warn)} .status.bad{background:var(--bad)}

    /* ===== Layout cartes ===== */
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px}
    .card{border:1px solid var(--br);background:var(--card);padding:16px;border-radius:14px; box-shadow: var(--shadow)}
    .small{font-size:.92rem;color:var(--muted)}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas, "Liberation Mono","Courier New",monospace}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* ===== Liens rapides ===== */
    .quick ul{margin:6px 0 0 18px}
    .badge{display:inline-block;background:var(--badge-bg);border:1px solid var(--badge-br);border-radius:8px;padding:2px 8px;margin-left:6px}

    /* ===== R√©sum√© fen√™tres ===== */
    .wins .line{padding:10px 12px;border:1px solid var(--br);border-radius:12px;background:var(--card);margin-bottom:8px}
    .wins .title{font-weight:700}
    .go{display:inline-block; border-radius:10px; padding:2px 8px; margin-left:8px; font-weight:800; letter-spacing:.2px}
    .go.family{background: var(--ok); color: #04110a}
    .go.expert{background: #f59e0b; color: #160f04}
    .sep{opacity:.6; padding:0 6px}

    /* ===== Tableau radar spots ===== */
    .table-wrap{overflow:auto; border:1px solid var(--br); border-radius:14px}
    table{width:100%; border-collapse:collapse; background:var(--card)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--br); font-size:.95rem}
    th{text-align:left;color:var(--muted); position:sticky; top:0; background:var(--card)}
    tr:hover td{background:rgba(76,201,240,.06)}

    footer{margin-top:24px;color:var(--muted);font-size:.9rem}
    details.card summary{cursor:pointer}
  </style>
</head>
<body>
<header>
  <h1>fable-collector ‚Äî tableau de bord</h1>
  <span id="tz" class="pill"></span>
  <span id="gen" class="pill"></span>
  <span id="hc" class="status warn">Statut: ‚Ä¶</span>
  <span class="spacer"></span>
  <button id="themeBtn" class="btn" title="Basculer clair/sombre">üåô/‚òÄÔ∏è</button>
</header>

<div class="cards">
  <!-- === 1) Liens rapides (avec minimum requis) === -->
  <div class="card quick">
    <h3>Liens rapides</h3>
    <ul id="quicklinks"></ul>
    <p class="small">Inventaire bas√© sur <span class="mono">index.json</span>.</p>
  </div>

  <!-- === 2) R√©sum√© fen√™tres (afficher SEULEMENT spots ayant ‚â•1 fen√™tre) === -->
  <div class="card wins">
    <h3>R√©sum√© fen√™tres</h3>
    <div id="wins">Chargement‚Ä¶</div>
  </div>
</div>

<!-- === 3) Radar des spots (ex-spots collect√©s), uniquement fichiers de spots === -->
<h3 style="margin-top:18px">Radar des spots</h3>
<div class="card table-wrap">
  <table id="files"><thead>
    <tr><th>Spot (fichier)</th><th>Taille</th><th>Modifi√©</th><th>Statut</th></tr>
  </thead><tbody></tbody></table>
</div>

<footer>
  <p>Affichage en <span id="tz2" class="mono"></span>. Les heures dans les fichiers sont ISO (avec ou sans offset) et s‚Äôentendent c√¥t√© collecte (souvent Africa/Tunis).</p>
</footer>

<script>
(function(){
  // === Pr√©f√©rences de th√®me ===
  const root = document.documentElement;
  const saved = localStorage.getItem('theme');
  if(saved){ root.setAttribute('data-theme', saved); }
  document.getElementById('themeBtn').addEventListener('click', ()=>{
    const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    root.setAttribute('data-theme', next); localStorage.setItem('theme', next);
  });
})();
</script>

<script>
(async function(){
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

  $('#tz').textContent = 'Affichage: ' + tz;
  $('#tz2').textContent = tz;

  const WANT_SPOTS = [
    ['Gammarth (home)', 'gammarth-port.json'],
    ['Sidi Bou Sa√Ød',   'sidi-bou-said.json'],
    ['Ghar el Melh',    'ghar-el-melh.json'],
    ['Ras Fartass',     'ras-fartass.json'],
    ['El Haouaria',     'el-haouaria.json']
  ];
  const SPOT_FILES = new Set(WANT_SPOTS.map(x=>x[1]));

  const fmtBytes = (n)=>{
    if(n==null) return '';
    if(n<1024) return n+' B';
    if(n<1024*1024) return (n/1024).toFixed(1)+' kB';
    return (n/1024/1024).toFixed(1)+' MB';
  };
  const toLocal = (iso)=>{
    try{ const d=new Date(iso); return isNaN(d)? iso : d.toLocaleString('fr-TN', { timeZone: tz }); }
    catch(e){ return iso||''; }
  };
  const toFriendly = (iso)=>{
    try{
      const d = new Date(iso);
      if(isNaN(d)) return iso||'?';
      const s = d.toLocaleString('fr-TN', { weekday:'long', hour:'numeric', minute:'2-digit', hour12:true, timeZone: tz });
      return s.charAt(0).toUpperCase()+s.slice(1);
    }catch(e){ return iso||'?'; }
  };
  const hoursBetween = (a,b)=>{
    const da = new Date(a), db = new Date(b);
    if(isNaN(da) || isNaN(db)) return '';
    const h = Math.round((db - da) / 36e5);
    return h;
  };
  const fetchJSON = async (path)=>{
    try{
      const r = await fetch(path, {cache:'no-store'});
      if(!r.ok) throw new Error(r.status+' '+r.statusText);
      return await r.json();
    }catch(e){ return null; }
  };

  const index   = await fetchJSON('index.json');
  const status  = await fetchJSON('status.json');   // peut √™tre null
  const windows = await fetchJSON('windows.json');  // peut √™tre null
  const catalog = await fetchJSON('catalog.json');  // peut √™tre null

  const files = (index && Array.isArray(index.files)) ? index.files
              : (catalog && Array.isArray(catalog.files)) ? catalog.files
              : [];
  const presentPaths = new Set(files.map(f => typeof f==='string' ? f : f.path));

  // === Pastille statut ===
  const hc = $('#hc');
  if(status && Array.isArray(status.files)){
    const ok = !!status.all_fresh;
    hc.className = 'status ' + (ok ? 'ok' : 'warn');
    hc.textContent = ok ? 'Statut: OK (fichiers frais)' : 'Statut: ATTENTION (anciens)';
  }else{
    hc.className = 'status bad';
    hc.textContent = 'Statut: indisponible';
  }

  // === G√©n√©r√© √†‚Ä¶ ===
  const gen = (windows && windows.generated_at)
           || (index && index.generated_at)
           || (catalog && catalog.generated_at)
           || null;
  $('#gen').textContent = 'G√©n√©r√©: ' + (gen ? toLocal(gen) : 'inconnu');

  // === (1) Liens rapides ‚Äî entr√©es avec descriptions ===
  const has = (p)=> presentPaths.has(p);
  const winLinks = [has('windows.json') ? '<a href="windows.json">windows.json</a>' : null,
                    has('windows.md')   ? '<a href="windows.md">windows.md</a>'     : null]
                     .filter(Boolean).join(' ¬∑ ');
  const items = [];
  if(has('index.json')) items.push(`<li><a href="index.json">index.json</a> ‚Äî inventaire produit par <span class="mono">main.py</span></li>`);
  if(has('catalog.json')) items.push(`<li><a href="catalog.json">catalog.json</a> ‚Äî liste des fichiers r√©ellement pr√©sents</li>`);
  if(winLinks) items.push(`<li>${winLinks} ‚Äî fen√™tres <span class="mono">Family GO</span> d√©tect√©es</li>`);
  if(has('status.json')) items.push(`<li><a href="status.json">status.json</a></li>`);
  if(has('status.html')) items.push(`<li><a href="status.html">status.html</a></li>`);
  if(has('rules.normalized.json')) items.push(`<li><a href="rules.normalized.json">rules.normalized.json</a></li>`);
  ql.innerHTML = items.join('');

  // === (3) Radar des spots ‚Äî UNIQUEMENT les fichiers spot.* ===
  const tbody = $('#files tbody');
  const isSpotPath = (p)=> SPOT_FILES.has(p) || (/\.json$/i.test(p) && !(new Set(['index.json','catalog.json','status.json','rules.normalized.json','windows.json']).has(p)));
  function isFreshEntry(entry, fallbackModIso){
    if(!entry){
      if(!fallbackModIso) return null;
      const ageMin = (Date.now() - new Date(fallbackModIso).getTime())/60000;
      const thr = (status && (status.threshold_minutes||status.max_age_minutes||status.fresh_minutes)) || 180; // d√©faut 3h
      return ageMin <= thr;
    }
    if('fresh' in entry) return !!entry.fresh;
    if('is_fresh' in entry) return !!entry.is_fresh;
    if('stale' in entry) return !entry.stale;
    if('age_minutes' in entry){
      const thr = (status && (status.threshold_minutes||status.max_age_minutes||status.fresh_minutes)) || 180;
      return entry.age_minutes <= thr;
    }
    return null;
  }
  const spotRows = files
    .map(f => typeof f==='string' ? {path:f} : f)
    .filter(f => isSpotPath(f.path));

  if(spotRows.length===0){
    tbody.innerHTML = '<tr><td colspan="4" class="small warn">Aucun spot list√©.</td></tr>';
  }else{
    // trier par ordre attendu WANT_SPOTS puis le reste alpha
    const order = new Map(WANT_SPOTS.map((x,i)=>[x[1],i]));
    spotRows.sort((a,b)=>{
      const ia = order.has(a.path) ? order.get(a.path) : 1e9;
      const ib = order.has(b.path) ? order.get(b.path) : 1e9;
      if(ia!==ib) return ia-ib;
      return (a.path||'').localeCompare(b.path||'');
    });

    for(const f of spotRows){
      const p = f.path || '';
      const size = f.size!=null ? fmtBytes(f.size) : '';
      const mod  = f.modified ? toLocal(f.modified) : '';
      const freshEntry = (status && status.files && status.files.find(s=>s.path===p)) || null;
      const freshBool = isFreshEntry(freshEntry, f.modified);
      let stat = '';
      if(freshBool===true) stat = '<span class="ok">frais</span>';
      else if(freshBool===false) stat = '<span class="warn">ancien</span>';
      else stat = '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="${encodeURIComponent(p)}">${WANT_SPOTS.find(x=>x[1]===p)?.[0] || p}</a>
          <span class="badge mono">${p}</span></td>
        <td class="mono">${size||''}</td>
        <td class="mono">${mod||''}</td>
        <td>${stat}</td>`;
      tbody.appendChild(tr);
    }
  }

  // === (2) R√©sum√© fen√™tres ‚Äî uniquement spots avec ‚â•1 fen√™tre ===
  const winsDiv = $('#wins');
  const DEST_OK = new Set([...SPOT_FILES]); // limiter aux spots connus

  function labelFor(seg){
    const s = (seg.label||seg.kind||seg.type||seg.mode||seg.level||seg.tier||seg.grade||seg.decision||'').toString().toLowerCase();
    if(/family|famille/.test(s)) return 'FAMILY GO';
    if(/expert/.test(s)) return 'EXPERT GO';
    if(Array.isArray(seg.tags)){
      const tags = seg.tags.map(t=> t && t.toString().toLowerCase());
      if(tags.some(t=>/family|famille/.test(t))) return 'FAMILY GO';
      if(tags.some(t=>/expert/.test(t))) return 'EXPERT GO';
    }
    if(seg.family===true || seg.family_go===true) return 'FAMILY GO';
    if(seg.expert===true || seg.expert_only===true) return 'EXPERT GO';
    return 'FEN√äTRE';
  }
  function goClass(lbl){
    return lbl.startsWith('FAMILY') ? 'family' : (lbl.startsWith('EXPERT') ? 'expert' : '');
  }

  if(!windows || !Array.isArray(windows.windows)){
    winsDiv.innerHTML = '<span class="small">windows.json introuvable ou vide.</span>';
  }else{
    const items = [];
    for(const dest of windows.windows){
      const name = dest.dest_name || dest.dest_slug || '?';
      const slug = dest.dest_slug || dest.slug || dest.file || '';
      if(slug && !DEST_OK.has(slug)) continue; // n'afficher que les spots
      if(!Array.isArray(dest.windows) || dest.windows.length===0) continue; // seulement avec fen√™tre

      for(const seg of dest.windows){
        const start = seg.start ? toFriendly(seg.start) : '?';
        const end   = seg.end ? toFriendly(seg.end) : '?';
        const dur   = seg.hours || hoursBetween(seg.start, seg.end) || '';
        const conf  = (seg.confidence || seg.conf || '').toString();
        const lbl   = labelFor(seg);
        const cls   = goClass(lbl);

        const line = document.createElement('div');
        line.className = 'line';
        line.innerHTML = `
          <div class="title">${name} <span class="go ${cls}">${lbl}</span></div>
          <div class="small">${start} <span class="sep">‚ü∑</span> ${end} <span class="sep">‚ü∑</span> ${dur?dur+' h':''} <span class="sep">‚ü∑</span> ${conf || ''}</div>
        `;
        items.push(line);
      }
    }

    if(items.length===0){
      winsDiv.innerHTML = '<span class="small">Aucune fen√™tre d√©tect√©e.</span>';
    }else{
      winsDiv.innerHTML = '';
      items.forEach(el=> winsDiv.appendChild(el));
    }
  }
})();
</script>

<details class="card" style="margin-top:16px">
  <summary>Format JSON (extrait)</summary>
  <pre class="small" style="white-space:pre-wrap">
{
  "meta": {
    "name": "Gammarth (port)",
    "slug": "gammarth-port.json",
    "tz": "Africa/Tunis",
    "lat": 36.9203,
    "lon": 10.2846,
    "sources": ["open-meteo:ecmwf", "open-meteo:marine"]
  },
  "hourly": {
    "time": ["2025-09-12T00:00", "2025-09-12T01:00", "..."],
    "wind_speed_10m": [..km/h..],
    "wind_gusts_10m": [..km/h..],
    "wind_direction_10m": [..deg..],
    "weather_code": [..wmo..],
    "visibility": [..m ou km..],
    "hs": [..m..],       // alias: wave_height
    "tp": [..s..]        // alias: wave_period
  }
}
  </pre>
</details>

</body>
</html>
