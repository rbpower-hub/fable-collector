<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>fable-collector — tableau de bord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#0b1020;--fg:#e8eef6;--muted:#9fb3c8;--accent:#4cc9f0;
      --ok:#2dd4bf;--warn:#f59e0b;--bad:#ef4444;--br:#23304a;--card:#0f172a
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:1080px;margin:22px auto;padding:0 14px}
    header{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:14px}
    header h1{font-size:1.25rem;margin:0}
    .pill{border:1px solid var(--br);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:.85rem}
    .pill.ok{color:var(--ok)} .pill.warn{color:var(--warn)} .pill.bad{color:var(--bad)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid var(--br);background:var(--card);padding:14px;border-radius:14px}
    h3{margin:0 0 8px 0;font-size:1.05rem;color:var(--fg)}
    ul{margin:8px 0 0 18px}
    .small{font-size:.9rem;color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--br);font-size:.92rem}
    th{text-align:left;color:var(--muted)}
    .badge{display:inline-block;border:1px solid var(--br);border-radius:8px;padding:2px 8px;margin-left:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    footer{margin:14px 0 28px 0;color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>fable-collector — tableau de bord</h1>
    <span id="tz-pill" class="pill"></span>
    <span id="gen-pill" class="pill"></span>
    <span id="status-pill" class="pill bad">Statut : indisponible</span>
  </header>

  <div class="grid">
    <section class="card">
      <h3>Liens rapides</h3>
      <ul>
        <li><a href="index.json">index.json</a> <span class="small">— inventaire publié</span></li>
        <li><a href="status.json">status.json</a> · <a href="status.html">status.html</a> <span class="small">— fraîcheur</span></li>
        <li><a href="rules.normalized.json">rules.normalized.json</a> <span class="small">— règles normalisées</span></li>
        <li><a href="windows.json">windows.json</a> · <a href="windows.md">windows.md</a> <span class="small">— fenêtres détectées</span></li>
        <li><a href="catalog.json">catalog.json</a> <span class="small">— snapshot des fichiers</span></li>
      </ul>
    </section>

    <section class="card">
      <h3>Résumé fenêtres (48 h)</h3>
      <div id="wins">Chargement…</div>
    </section>
  </div>

  <h3 style="margin:16px 0 6px 0">Spots collectés</h3>
  <section class="card">
    <table id="files"><thead>
      <tr><th>Fichier</th><th>Taille</th><th>Modifié (local)</th><th>Type</th></tr>
    </thead><tbody></tbody></table>
  </section>

  <footer>
    <p>Affichage en <span id="tz2" class="mono"></span>. Les heures dans les fichiers sont ISO et s’entendent côté collecte (souvent Africa/Tunis).</p>
  </footer>
</div>

<script>
(async function(){
  const tzLocal = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
  document.getElementById('tz-pill').textContent = 'Affichage : ' + tzLocal;
  document.getElementById('tz2').textContent = tzLocal;

  async function getJSON(url){
    try{
      const r = await fetch(url,{cache:'no-store'});
      if(!r.ok) throw new Error(r.status+' '+r.statusText);
      return await r.json();
    }catch(e){ return null; }
  }
  function fmtBytes(n){ if(!Number.isFinite(n)) return ''; if(n<1024) return n+' B'; if(n<1048576) return (n/1024).toFixed(1)+' kB'; return (n/1048576).toFixed(1)+' MB'; }
  const toLocal = s => { try{ return new Date(s).toLocaleString(); }catch{ return s||''; } };

  // --- charge fichiers clés
  const [idx, cat, wins, stat] = await Promise.all([
    getJSON('index.json'), getJSON('catalog.json'), getJSON('windows.json'), getJSON('status.json')
  ]);

  // --- "Généré" (prend ce qu'on a)
  const genAt = (wins && wins.generated_at) || (idx && idx.generated_at) || (stat && stat.generated_at) || null;
  document.getElementById('gen-pill').textContent = 'Généré : ' + (genAt ? toLocal(genAt) : 'inconnu');

  // --- Statut (si status.json existe)
  const statusPill = document.getElementById('status-pill');
  if(stat && typeof stat.all_fresh === 'boolean'){
    statusPill.className = 'pill ' + (stat.all_fresh ? 'ok' : 'warn');
    statusPill.textContent = (stat.all_fresh ? 'Statut : OK — fichiers frais' : 'Statut : ATTENTION — fichiers anciens');
  } // sinon on garde "indisponible" (status.* absent ➜ 404)

  // --- Tableau "Spots collectés"
  const EXCLUDE = new Set(['index.json','catalog.json','rules.normalized.json','status.json','windows.json']);
  const tbody = document.querySelector('#files tbody');
  const files = (cat && Array.isArray(cat.files) ? cat.files : (idx && idx.files) || [])
               .map(x => typeof x === 'string' ? {path:x} : x);

  if(files.length === 0){
    tbody.innerHTML = '<tr><td colspan="4" class="small">Aucun fichier listé.</td></tr>';
  }else{
    // Ne garder que les "spots" (json ≠ fichiers techniques)
    const spotFiles = files.filter(f => f.path && f.path.endsWith('.json') && !EXCLUDE.has(f.path));
    for(const f of spotFiles){
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td><a href="${encodeURIComponent(f.path)}">${f.path}</a></td>
         <td class="mono">${fmtBytes(f.size)}</td>
         <td class="mono">${f.modified ? toLocal(f.modified) : ''}</td>
         <td>spot</td>`;
      tbody.appendChild(tr);
    }
  }

  // --- Résumé fenêtres (on n’affiche que les fenêtres "family")
  const winsDiv = document.getElementById('wins');
  if(!wins || !Array.isArray(wins.windows)){
    winsDiv.innerHTML = '<span class="small">windows.json introuvable ou vide.</span>';
  }else{
    // Ignorer entrées non-spots (catalog, rules.normalized, etc.)
    const notSpot = /^(index|catalog|rules\.normalized|windows|status)/i;
    const ul = document
