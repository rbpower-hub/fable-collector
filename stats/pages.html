<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>fable-collector — tableau de bord</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--bg:#0b1020;--fg:#e8eef6;--muted:#9fb3c8;--accent:#4cc9f0;--ok:#2dd4bf;--warn:#f59e0b;--bad:#dc2626;--card:#0f172a;--line:#23304a}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:24px;background:var(--bg);color:var(--fg)}
    a{color:var(--accent)}
    header{display:flex;flex-wrap:wrap;gap:8px;align-items:baseline;margin-bottom:16px}
    header h1{font-size:1.4rem;margin:0}
    .pill{border:1px solid var(--line);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:.85rem}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
    .card{border:1px solid var(--line);background:var(--card);padding:14px;border-radius:14px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--line);font-size:.92rem}
    th{text-align:left;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .small{font-size:.9rem;color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    footer{margin-top:24px;color:var(--muted);font-size:.9rem}
    .badge{display:inline-block;background:#152033;border:1px solid var(--line);border-radius:8px;padding:2px 8px;margin-left:6px}
    ul{margin:0 0 0 1rem}
  </style>
</head>
<body>
<header>
  <h1>fable-collector — tableau de bord</h1>
  <span id="tz" class="pill"></span>
  <span id="gen" class="pill"></span>
  <span id="health" class="pill">Statut: inconnu</span>
</header>

<div class="cards">
  <div class="card">
    <h3>Liens rapides</h3>
    <ul>
      <li><a href="index.json">index.json</a> <span class="small">— inventaire publié</span></li>
      <li><a href="status.json">status.json</a> · <a href="status.html">status.html</a> <span class="small">— fraîcheur</span></li>
      <li><a href="rules.normalized.json">rules.normalized.json</a> <span class="small">— règles normalisées</span></li>
      <li><a href="windows.json">windows.json</a> <span class="small">— fenêtres détectées (si reader activé)</span></li>
      <li id="li-catalog" style="display:none"><a href="catalog.json">catalog.json</a> <span class="small">— snapshot des fichiers</span></li>
    </ul>
  </div>

  <div class="card">
    <h3>Résumé fenêtres</h3>
    <div id="wins" class="small">Chargement…</div>
  </div>

  <div class="card">
    <h3>Spots collectés</h3>
    <table id="files"><thead>
      <tr><th>Fichier</th><th>Taille</th><th>Modifié</th><th>État</th></tr>
    </thead><tbody></tbody></table>
  </div>
</div>

<footer>
  <p>Affichage en <span id="tz2" class="mono"></span>. Les heures dans les fichiers sont ISO et s’entendent côté collecte (souvent Africa/Tunis).</p>
</footer>

<script>
(async function(){
  const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
  document.getElementById('tz').textContent = 'Affichage: ' + tz;
  document.getElementById('tz2').textContent = tz;

  // --- helpers ---
  function fmtBytes(n){
    if(n==null) return '';
    if(n<1024) return n+' B';
    if(n<1024*1024) return (n/1024).toFixed(1)+' kB';
    return (n/1024/1024).toFixed(1)+' MB';
  }
  function toLocal(iso){
    try{ const d=new Date(iso); return isNaN(d)? iso : d.toLocaleString(); }catch{ return iso||''; }
  }
  async function fetchJSON(path){
    try{
      const r = await fetch(path, {cache:'no-store'});
      if(!r.ok) throw new Error(r.status+' '+r.statusText);
      return await r.json();
    }catch(e){ return null; }
  }

  // --- charger éventuels fichiers ---
  const [idx, cat, status, wins] = await Promise.all([
    fetchJSON('index.json'),
    fetchJSON('catalog.json'),
    fetchJSON('status.json'),
    fetchJSON('windows.json')
  ]);

  // Généré à
  const gen = (wins && wins.generated_at) || (status && status.generated_at) || (idx && idx.generated_at) || null;
  document.getElementById('gen').textContent = 'Généré: ' + (gen ? toLocal(gen) : 'inconnu');

  // Statut / fraîcheur
  const health = document.getElementById('health');
  if(status && typeof status.all_fresh === 'boolean'){
    health.textContent = status.all_fresh ? 'Statut: OK — fichiers frais' : 'Statut: ATTENTION — fichiers anciens';
    health.className = 'pill ' + (status.all_fresh ? 'ok' : 'warn');
  }else{
    health.textContent = 'Statut: indisponible';
    health.className = 'pill bad';
  }

  // Afficher le lien catalog.json si présent
  if(cat && Array.isArray(cat.files)){
    document.getElementById('li-catalog').style.display = '';
  }

  // Table fichiers (priorité catalog.json, sinon index.json)
  const tbody = document.querySelector('#files tbody');
  let files = [];
  if(cat && Array.isArray(cat.files)) files = cat.files;
  else if(idx && Array.isArray(idx.files)) files = idx.files;

  // Pour chaque entrée, tenter de croiser avec status.json pour l'état
  const statusMap = new Map();
  if(status && Array.isArray(status.files)){
    for(const f of status.files) statusMap.set(f.path, f);
  }

  if(!files.length){
    tbody.innerHTML = '<tr><td colspan="4" class="small warn">Aucun fichier listé.</td></tr>';
  }else{
    for(const f of files){
      const path = f.path || f;
      const size = fmtBytes(f.size);
      const mod  = toLocal(f.modified || (statusMap.get(path)?.modified_local));
      const fres = statusMap.has(path) ? (statusMap.get(path).ok_fresh ? 'OK' : 'Ancien') : '—';
      const cls  = fres==='OK' ? 'ok' : (fres==='Ancien' ? 'warn' : 'small');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><a class="mono" href="${encodeURIComponent(path)}">${path}</a></td>
                      <td class="mono">${size||''}</td>
                      <td class="mono">${mod||''}</td>
                      <td class="${cls}">${fres}</td>`;
      tbody.appendChild(tr);
    }
  }

  // Résumé fenêtres
  const winsDiv = document.getElementById('wins');
  if(!wins || !Array.isArray(wins.windows)){
    winsDiv.textContent = 'windows.json introuvable ou vide.';
  }else if(wins.windows.length === 0){
    winsDiv.textContent = 'Aucune fenêtre Family GO détectée.';
  }else{
    const ul = document.createElement('ul');
    for(const dest of wins.windows){
      const name = dest.dest_name || dest.dest_slug || '?';
      if(!Array.isArray(dest.windows) || !dest.windows.length){
        const li = document.createElement('li');
        li.innerHTML = `<span>${name}</span> <span class="small">— aucune fenêtre</span>`;
        ul.appendChild(li);
        continue;
      }
      for(const seg of dest.windows){
        const li = document.createElement('li');
        const start = seg.start ? toLocal(seg.start) : '?';
        const end   = seg.end ? toLocal(seg.end) : '?';
        const conf  = seg.confidence || '';
        li.innerHTML = `<span class="ok">${name}</span> — ${start} → ${end}
                        <span class="badge">${seg.hours} h</span>
                        <span class="badge">${conf}</span>`;
        ul.appendChild(li);
      }
    }
    winsDiv.innerHTML = '';
    winsDiv.appendChild(ul);
  }
})();
</script>
</body>
</html>
